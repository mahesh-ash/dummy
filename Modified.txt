import { API_CONFIG } from '@/lib/constants';
import React, { useState, useEffect } from 'react';
import { useToast } from '@/hooks/use-toast';
import { createAuthHeaders } from '@/lib/legacyUtils';

type NormalizedContact = {
    contactId: string;
    contactName: string;
    accountName: string;
    accountType: string;
    lastInteractedDateMe: string;
    comments: string;
    email?: string;
};
type RawContactItem = NormalizedContact;

interface FilterObject {
    isExcelGenerate: boolean;
    daysAgo: string;
    accountName: string[];
    includeAccName: boolean;
    excludeAccName: boolean;
    accountType: string[];
    includeAccType: boolean;
    excludeAccType: boolean;
    tier: any[];
    conSubRes: boolean;
    myCoveredContact: boolean;
    distributionList: boolean;
    list: any[];
    conAccVoted: boolean;
    conAccVotedMe: boolean;
    conSubMyRes: boolean;
    conSubMyCovTicker: boolean;
    allCriteria: boolean;
    oneOrMoreCriteria: boolean;
}

const initialFilterObj: FilterObject = {
    "isExcelGenerate": false,
    "daysAgo": "",
    "accountName": [],
    "includeAccName": true,
    "excludeAccName": false,
    "accountType": [],
    "includeAccType": true,
    "excludeAccType": false,
    "tier": [],
    "conSubRes": false,
    "myCoveredContact": false,
    "distributionList": false,
    "list": [],
    "conAccVoted": false,
    "conAccVotedMe": false,
    "conSubMyRes": false,
    "conSubMyCovTicker": false,
    "allCriteria": true,
    "oneOrMoreCriteria": false
};

// declare const config: { fadingContactLimit: number };

export const FadingContactComponent = ({ tabType }: { tabType: string }) => {
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);
    const [contacts, setContacts] = useState<NormalizedContact[]>([]);
    
    const { toast } = useToast(); 

    const fetchFadingContacts = async () => {
        setIsLoading(true);
        try {
            const startVar = 0;
            const lengVar = 0;

            const filterDataStr = JSON.stringify(initialFilterObj);
            
            const bodyParams = new URLSearchParams({
                "top": 'collapse',
                "action": 'collapse',
                "start": startVar.toString(),
                "length": lengVar.toString(),
                "data": filterDataStr
            }).toString();

            const response = await fetch(`${API_CONFIG.baseUrl}/contact/retrievefadingcontact`, {
                method: 'POST',
                headers: createAuthHeaders({
                    'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
                    'Accept': 'application/json, text/javascript, */*; q=0.01',
                }),
                body: bodyParams,
                credentials: 'include',
            });

            const data = await response.json();

            if (data.status === 1 || data.status === 0) {
                const rawContacts: RawContactItem[] = Array.isArray(data.data) ? data.data : [];
                setContacts(rawContacts);
            } else {
                setContacts([]);
            }

        } catch (err) {
            console.error('fetchFadingContacts error', err);
            setError('Failed to fetch fading contacts.');
            toast({ title: 'Error', description: 'Failed to fetch contacts' });
        } finally {
            setIsLoading(false);
        }
    };

    useEffect(() => {
        fetchFadingContacts();
    }, [tabType]);

    if (isLoading) {
        return <div>Loading fading contacts...</div>;
    }

    if (contacts.length === 0) {
        return <p className="align-center">No fading contacts found.</p>;
    }

    return (
        <div className="p-5">
            <ul className="space-y-3">
                {contacts.map((contact) => {
                    return (
                        <li key={contact.contactId} className="relative rounded border bg-gray-50 p-3 shadow-sm">
                            <h3 
                                className="font-bold" 
                                dangerouslySetInnerHTML={{ __html: contact.contactName }} 
                            />
                            <p className="text-sm text-gray-600">
                                Email: {contact.email} | Account Type: {contact.accountType} |
                                Account: <span dangerouslySetInnerHTML={{ __html: contact.accountName }} /> | 
                                Last Interacted: {contact.lastInteractedDateMe}
                            </p>
                            {/* <p>Comments: {contact.comments}</p> */}
                        </li>
                    )
                })}
            </ul>
        </div>
    );
};

export default FadingContactComponent;
