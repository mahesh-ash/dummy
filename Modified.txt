import * as Dialog from '@radix-ui/react-dialog'
import { Input } from '@/components/ui/input'
import React, { useEffect, useRef, useState } from 'react'
import DatePicker from 'react-datepicker'
import 'react-datepicker/dist/react-datepicker.css'
import { useToast } from '@/hooks/use-toast'
import { createAuthHeaders } from '@/lib/legacyUtils'
import { API_CONFIG } from '@/lib/constants'
import { prismStorage } from '@/lib/prismStorage'
import { Search, X, Calendar, Clock, User, FileText, Tag } from 'lucide-react'

type TaskItem = {
  taskId: string
  taskName?: string
  taskComment?: string
  taskDate?: string
  taskAssignedName?: string
  taskAssignedId?: string
  taskType?: string
  taskStatus?: string
  contacts?: string[]
  contactName?: string[]
  accountName?: string[]
  taskComments?: string
  reminder?: any[]
}

interface AssigneeOption {
  text?: string
  value?: string
  code?: string
  style?: string
  docName?: string | null
  docId?: string | null
}

interface ContactOption {
  text?: string
  value?: string
  code?: string
  style?: string
  docName?: string | null
  docId?: string | null
  account_name?: string
}

export default function TasksWidget() {
  const { toast } = useToast()
  const [tasks, setTasks] = useState<TaskItem[]>([])
  const [loading, setLoading] = useState(false)
  const [editTask, setEditTask] = useState<TaskItem | null>(null)
  const [subject, setSubject] = useState('')
  const [taskType, setTaskType] = useState('')
  const [status, setStatus] = useState('')
  const [description, setDescription] = useState('')
  const [dueDate, setDueDate] = useState<Date | null>(new Date())
  const [timeStr, setTimeStr] = useState('10:00')
  const [query, setQuery] = useState('')
  const [assigneeResults, setAssigneeResults] = useState<AssigneeOption[]>([])
  const [loadingSearch, setLoadingSearch] = useState(false)
  const [isOpen, setIsOpen] = useState(false)
  const [isModalOpen, setModalOpen] = useState(false)
  const inputRef = useRef(null)
  const [assignedToName, setAssignedToName] = useState('')
  const [isViewModalOpen, setIsViewModalOpen] = useState(false)
  const [selectedTask, setSelectedTask] = useState<TaskItem | null>(null)
  const [assignedToId, setAssignedToId] = useState('')
  const [contactNames, setContactNames] = useState<string[]>([])
  const [contacts, setContacts] = useState<string[]>([])
  const [contactQuery, setContactQuery] = useState('')
  const [contactResults, setContactResults] = useState<ContactOption[]>([])
  const [loadingContacts, setLoadingContacts] = useState(false)
  const [isContactResultsOpen, setIsContactResultsOpen] = useState(false)
  
  // Pagination states
  const [displayCount, setDisplayCount] = useState(4)
  const [showAll, setShowAll] = useState(false)

  const openViewModal = (task: TaskItem) => {
    setSelectedTask(task)
    setIsViewModalOpen(true)
  }

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setQuery(e.target.value)
    if (!e.target.value) {
      setIsOpen(false)
    } else {
      setIsOpen(true)
    }
    if (!isModalOpen) setModalOpen(true)
  }

  const closeViewModal = () => {
    setIsViewModalOpen(false)
    setSelectedTask(null)
  }

  interface ViewTaskModalProps {
    isOpen: boolean
    onClose: () => void
    task: TaskItem
  }

  const ViewTaskModal: React.FC<ViewTaskModalProps> = ({ isOpen, onClose, task }) => {
    return (
      <Dialog.Root open={isOpen} onOpenChange={onClose}>
        <Dialog.Portal>
          <Dialog.Overlay className="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm" />
          <Dialog.Content className="fixed left-1/2 top-1/2 z-50 w-full max-w-2xl -translate-x-1/2 -translate-y-1/2 rounded-xl bg-white shadow-2xl">
            <div className="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 rounded-t-xl">
              <Dialog.Title className="text-2xl font-bold text-white">
                Task Details
              </Dialog.Title>
            </div>
            
            <div className="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
              <div className="bg-blue-50 border-l-4 border-blue-600 p-4 rounded-r-lg">
                <h3 className="text-lg font-semibold text-gray-800">{task.taskName}</h3>
              </div>

              <div className="grid grid-cols-2 gap-4">
                <div className="flex items-start space-x-3">
                  <Tag className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-500">Status</p>
                    <p className={`text-base font-semibold ${
                      task.taskStatus === 'Completed' ? 'text-green-600' :
                      task.taskStatus === 'In Progress' ? 'text-yellow-600' :
                      'text-gray-600'
                    }`}>{task.taskStatus}</p>
                  </div>
                </div>

                <div className="flex items-start space-x-3">
                  <Calendar className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-500">Due Date</p>
                    <p className="text-base font-semibold text-gray-800">
                      {new Date(task.taskDate).toLocaleString()}
                    </p>
                  </div>
                </div>

                <div className="flex items-start space-x-3">
                  <User className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-500">Assignee</p>
                    <p className="text-base font-semibold text-gray-800">{task.taskAssignedName}</p>
                  </div>
                </div>

                <div className="flex items-start space-x-3">
                  <FileText className="w-5 h-5 text-blue-600 mt-0.5" />
                  <div>
                    <p className="text-sm font-medium text-gray-500">Task Type</p>
                    <p className="text-base font-semibold text-gray-800">{task.taskType}</p>
                  </div>
                </div>
              </div>

              <div className="border-t pt-4">
                <p className="text-sm font-medium text-gray-500 mb-2">Description</p>
                <p className="text-gray-700 bg-gray-50 p-3 rounded-lg">{task.taskComment || 'No description'}</p>
              </div>

              {task.accountName && task.accountName.length > 0 && (
                <div className="border-t pt-4">
                  <p className="text-sm font-medium text-gray-500 mb-2">Account</p>
                  <div className="flex flex-wrap gap-2">
                    {task.accountName.map((acc, idx) => (
                      <span key={idx} className="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        {acc}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {task.contactName && task.contactName.length > 0 && (
                <div className="border-t pt-4">
                  <p className="text-sm font-medium text-gray-500 mb-2">Contacts</p>
                  <div className="flex flex-wrap gap-2">
                    {task.contactName.map((contact, idx) => (
                      <span key={idx} className="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-medium">
                        {contact}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>

            <div className="bg-gray-50 px-6 py-4 rounded-b-xl flex justify-end">
              <Dialog.Close asChild>
                <button onClick={onClose} className="px-6 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium rounded-lg transition-colors">
                  Close
                </button>
              </Dialog.Close>
            </div>
          </Dialog.Content>
        </Dialog.Portal>
      </Dialog.Root>
    )
  }

  const normalizeToArray = (data: any) => (Array.isArray(data) ? data : data ? [data] : [])

  async function fetchTasks() {
    setLoading(true)
    try {
      const summaryFilter = prismStorage.get('summaryFilter') || JSON.stringify({ filter: [] })
      const body = new URLSearchParams({ summaryFilter }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/getTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        const rawTasks = Array.isArray(data.data) ? data.data : []
        const normalizedTasks = rawTasks.map((task: any) => {
          const contactIds = task.contactList
            ? task.contactList.map((contactItem: any) => contactItem.contact_id)
            : []
          const contactNames = task.contactList
            ? task.contactList.map((contactItem: any) => contactItem.contact_name)
            : []
          const accountNames = task.contactList
            ? task.contactList.map((contactItem: any) => contactItem.account_name)
            : []
          return {
            ...task,
            contacts: contactIds,
            contactName: contactNames,
            accountName: accountNames,
          }
        })
        setTasks(normalizedTasks)
      } else {
        setTasks([])
      }
    } catch (err) {
      console.error('fetchTasks error', err)
      toast({ title: 'Error', description: 'Failed to fetch tasks' })
    } finally {
      setLoading(false)
    }
  }

  async function fetchTaskDetails(taskId: string) {
    try {
      const body = new URLSearchParams({ taskId }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/getTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        }),
        body,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        if (Array.isArray(data.data) && data.data.length > 0) return data.data[0]
        return data.data || null
      }
      return null
    } catch (err) {
      return null
    }
  }

  useEffect(() => {
    fetchTasks()
  }, [])

  useEffect(() => {
    const timer = setTimeout(async () => {
      if (!query.trim()) {
        setAssigneeResults([])
        return
      }
      setLoadingSearch(true)
      const payload = {
        filtertype: 'employee',
        filterrpttype: 'Outlook',
        showuser: true,
        searchtext: query,
      }
      const queryString = new URLSearchParams(payload).toString()
      const requestUrl = `${API_CONFIG.baseUrl}/userconfig/searchfilters?${queryString}`
      try {
        const res = await fetch(requestUrl, {
          method: 'GET',
          headers: createAuthHeaders({
            Accept: 'application/json, text/javascript, */*; q=0.01',
          }),
          credentials: 'include',
        })
        const data: AssigneeOption[] = await res.json()
        if (Array.isArray(data)) {
          setAssigneeResults(data)
        } else {
          setAssigneeResults([])
        }
      } catch (err) {
        console.error('Fetch assignee error:', err)
        setAssigneeResults([])
      } finally {
        setLoadingSearch(false)
      }
    }, 300)
    return () => clearTimeout(timer)
  }, [query])

  useEffect(() => {
    const timer = setTimeout(async () => {
      if (!contactQuery.trim()) {
        setContactResults([])
        return
      }
      setLoadingContacts(true)
      const queryString = new URLSearchParams({
        filtertype: 'contact',
        restype: 'Detailed',
        searchtext: contactQuery,
      }).toString()
      const requestUrl = `${API_CONFIG.baseUrl}/userconfig/searchfilters?${queryString}`
      try {
        const res = await fetch(requestUrl, {
          method: 'GET',
          headers: createAuthHeaders({
            Accept: 'application/json, text/javascript, */*; q=0.01',
          }),
          credentials: 'include',
        })
        const data: ContactOption[] = await res.json()
        if (Array.isArray(data)) {
          setContactResults(data)
        } else {
          setContactResults([])
        }
      } catch (err) {
        console.error('Fetch contact error:', err)
        setContactResults([])
      } finally {
        setLoadingContacts(false)
      }
    }, 300)
    return () => clearTimeout(timer)
  }, [contactQuery])

  // FIX: Use contact.value and contact.text instead of contact.id and contact.name
  const handleContactSelect = (contact: ContactOption) => {
    const contactId = contact.value || ''
    const contactName = contact.text || ''
    
    if (!contacts.includes(contactId)) {
      setContacts((prev) => [...prev, contactId])
      setContactNames((prev) => [...prev, contactName])
    }
    console.log('Adding contact:', { id: contactId, name: contactName })
    setContactQuery('')
    setIsContactResultsOpen(false)
  }

  const handleContactInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setContactQuery(e.target.value)
    setIsContactResultsOpen(true)
  }

  // FIX: Properly remove contact by finding its index
  const removeContact = (contactId: string) => {
    const indexToRemove = contacts.indexOf(contactId)
    if (indexToRemove !== -1) {
      setContacts((prev) => prev.filter((_, idx) => idx !== indexToRemove))
      setContactNames((prev) => prev.filter((_, idx) => idx !== indexToRemove))
    }
  }

  const handleAssigneeSelect = (assignee: AssigneeOption) => {
    setQuery(assignee.text || '')
    setAssignedToId(assignee.value || '')
    setAssignedToName(assignee.text || '')
    setIsOpen(false)
  }

  async function handleAddTask() {
    try {
      if (!assignedToId.trim()) {
        toast({ title: 'Validation', description: 'Assignee required' })
        return
      }
      if (!subject.trim()) {
        toast({ title: 'Validation', description: 'Subject required' })
        return
      }
      const clienttimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || ''
      const dueDateStr = dueDate ? dueDate.toISOString().slice(0, 10) : ''
      const formattedDateTime = `${dueDateStr} ${timeStr}:00`
      
      // FIX: Ensure contacts array is properly sanitized
      const sanitizedContacts = contacts.filter(id => id != null && id !== '')
      const sanitizedContactNames = contactNames.filter(name => name != null && name !== '')

      console.log('Adding task with contacts:', { sanitizedContacts, sanitizedContactNames })

      const payloadObj = {
        subject,
        dueDate: formattedDateTime,
        dueTime: timeStr,
        contacts: sanitizedContacts,
        contactName: sanitizedContactNames,
        assignedTo: assignedToId,
        clienttimezone,
        status,
        taskType,
        taskComments: description,
        module_name: 'Task',
        action: 'Save',
      }
      
      const encoded = new URLSearchParams({ data: JSON.stringify(payloadObj) }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/addTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body: encoded,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        toast({ title: 'Success', description: 'Task Added Successfully' })
        setModalOpen(false)
        resetForm()
        fetchTasks()
      } else {
        toast({ title: 'Error', description: data?.message || 'Failed to add task' })
      }
    } catch (err) {
      console.error('handleAddTask', err)
      toast({ title: 'Error', description: 'Failed to add task' })
    }
  }

  async function handleUpdateTask() {
    try {
      if (!editTask) return
      const clienttimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || ''
      const dueDateStr = dueDate ? dueDate.toISOString().slice(0, 10) : ''
      const formattedDateTime = `${dueDateStr} ${timeStr}:00`
      
      // FIX: Sanitize contacts for update
      const sanitizedContacts = contacts.filter(id => id != null && id !== '')
      const sanitizedContactNames = contactNames.filter(name => name != null && name !== '')

      console.log('Updating task with contacts:', { sanitizedContacts, sanitizedContactNames })

      const payloadObj = {
        subject,
        dueDate: formattedDateTime,
        dueTime: timeStr,
        contacts: sanitizedContacts,
        contactName: sanitizedContactNames,
        assignedTo: assignedToId,
        clienttimezone,
        status,
        taskType,
        taskComments: description,
        module_name: 'Task',
        action: 'Update',
        taskId: editTask.taskId,
      }
      
      const encoded = new URLSearchParams({ data: JSON.stringify(payloadObj) }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/addTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body: encoded,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        toast({ title: 'Success', description: 'Task Updated Successfully' })
        setModalOpen(false)
        setEditTask(null)
        resetForm()
        fetchTasks()
      } else {
        toast({ title: 'Error', description: data?.message || 'Failed to update task' })
      }
    } catch (err) {
      console.error('handleUpdateTask', err)
      toast({ title: 'Error', description: 'Failed to update task' })
    }
  }

  async function openEditModal(task: TaskItem) {
    let tdata: any = task
    const missingContacts =
      !tdata.contacts || (Array.isArray(tdata.contacts) && tdata.contacts.length === 0)
    const missingName = !tdata.taskName && !tdata.subject

    if ((missingContacts || missingName) && tdata.taskId) {
      const full = await fetchTaskDetails(tdata.taskId)
      if (full) tdata = { ...tdata, ...full }
    }

    setEditTask(tdata)
    setSubject(tdata.taskName || tdata.subject || '')
    setDescription(tdata.taskComment || tdata.taskComments || '')
    const assignedId = tdata.taskAssignedId || tdata.assignedTo || ''
    setAssignedToId(assignedId)
    const assignedName = tdata.taskAssignedName || ''
    setQuery(assignedName)
    setAssignedToName(assignedName)
    setTaskType(tdata.taskType || '')
    setStatus(tdata.taskStatus || '')

    if (tdata.taskDate) {
      const iso = String(tdata.taskDate).replace(' ', 'T')
      const dt = new Date(iso)
      if (!isNaN(dt.getTime())) {
        setDueDate(dt)
        const hh = dt.getHours().toString().padStart(2, '0')
        const mm = dt.getMinutes().toString().padStart(2, '0')
        setTimeStr(`${hh}:${mm}`)
      } else {
        setDueDate(new Date())
        setTimeStr('10:00')
      }
    } else {
      setDueDate(new Date())
      setTimeStr('10:00')
    }

    // FIX: Properly load contacts and names from task
    const selectedIds = normalizeToArray(tdata.contacts)
    const selectedNames = normalizeToArray(tdata.contactName)
    
    setContacts(selectedIds)
    setContactNames(selectedNames)

    console.log('Editing task with contacts:', { selectedIds, selectedNames })

    setModalOpen(true)
  }

  async function deleteTask(taskId: string, originalTaskData: any) {
    try {
      const clienttimezone = Intl.DateTimeFormat().resolvedOptions().timeZone || ''
      const dueDateStr = dueDate
        ? dueDate.toISOString().slice(0, 10)
        : originalTaskData?.taskDate
          ? originalTaskData.taskDate.split(' ')[0]
          : ''
      const formattedDateTime = `${dueDateStr} ${timeStr}:00`
      
      // FIX: Include contacts in delete payload
      const taskContacts = normalizeToArray(originalTaskData?.contacts)
      const taskContactNames = normalizeToArray(originalTaskData?.contactName)

      const payload = {
        subject: originalTaskData?.subject || originalTaskData?.taskName || subject,
        dueDate: formattedDateTime,
        dueTime: timeStr,
        contacts: taskContacts,
        contactName: taskContactNames,
        assignedTo: originalTaskData?.taskAssignedId || originalTaskData?.assignedTo || '',
        clienttimezone,
        status: 'Dismiss',
        taskType: originalTaskData?.taskType || '',
        taskComments:
          originalTaskData?.taskComments || originalTaskData?.taskComment || description,
        module_name: 'Task',
        action: 'Dismiss',
        taskId: taskId,
      }
      
      const encoded = new URLSearchParams({ data: JSON.stringify(payload) }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/addTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body: encoded,
        credentials: 'include',
      })
      const data = await res.json()

      if (data?.status === 1) {
        toast({ title: 'Deleted', description: 'Task Deleted Successfully' })
        fetchTasks()
      } else {
        toast({ title: 'Error', description: data?.message || 'Delete failed' })
      }
    } catch (err) {
      console.error('deleteTask', err)
      toast({ title: 'Error', description: 'Delete failed' })
    }
  }

  function resetForm() {
    setSubject('')
    setAssignedToId('')
    setQuery('')
    setAssignedToName('')
    setTaskType('')
    setStatus('')
    setContacts([])
    setContactNames([])
    setDescription('')
    const now = new Date()
    setDueDate(now)
    const hh = now.getHours().toString().padStart(2, '0')
    const mm = now.getMinutes().toString().padStart(2, '0')
    const currentTimeString = `${hh}:${mm}`
    setTimeStr(currentTimeString)
  }

  const calcTimeData = (due: string | undefined) => {
    if (!due) return null
    const dueDate = new Date(due)
    const now = new Date()
    const diffMs = dueDate.getTime() - now.getTime()
    const isOverdue = diffMs < 0
    const absDiffMs = Math.abs(diffMs)
    const days = Math.floor(absDiffMs / 86400000)
    const hours = Math.floor((absDiffMs % 86400000) / 3600000)
    const mins = Math.floor(((absDiffMs % 86400000) % 3600000) / 60000)

    let timeDiffText
    if (days > 0) timeDiffText = `${days} Day(s)`
    else if (hours > 0) timeDiffText = `${hours} Hour(s)`
    else if (mins > 0) timeDiffText = `${mins} Min(s)`
    else timeDiffText = '0 Min(s)'

    const label = isOverdue ? 'Overdue' : 'Remaining'
    const statusClass = isOverdue ? 'bg-red-500' : 'bg-green-500'

    return {
      text: timeDiffText,
      fullText: `${timeDiffText} ${label}`,
      statusClass: statusClass,
    }
  }

  // Pagination logic
  const displayedTasks = showAll ? tasks : tasks.slice(0, displayCount)
  const hasMore = tasks.length > displayCount

  const handleToggleShowAll = () => {
    setShowAll(!showAll)
  }

  return (
    <div className="p-6 bg-gray-50 min-h-screen">
      <div className="max-w-7xl mx-auto">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-3xl font-bold text-gray-800">Tasks</h1>
          <button
            onClick={() => {
              setEditTask(null)
              resetForm()
              setModalOpen(true)
            }}
            className="flex items-center gap-2 rounded-lg bg-blue-600 hover:bg-blue-700 px-6 py-3 text-white font-medium shadow-lg transition-all"
          >
            <span className="text-xl">+</span>
            Add Task
          </button>
        </div>

        {loading ? (
          <div className="flex justify-center items-center h-64">
            <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
          </div>
        ) : tasks.length === 0 ? (
          <div className="bg-white rounded-lg shadow p-12 text-center">
            <p className="text-gray-500 text-lg">No tasks found</p>
          </div>
        ) : (
          <>
            <div className="grid gap-4">
              {displayedTasks.map((t) => {
                const timeData =
                  t.taskDate && t.taskStatus !== 'Completed' ? calcTimeData(t.taskDate) : null

                return (
                  <div
                    key={t.taskId}
                    className="bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow border border-gray-200 overflow-hidden"
                  >
                    <div className="p-5">
                      <div className="flex justify-between items-start mb-3">
                        <div className="flex-1">
                          <h3 className="text-xl font-bold text-gray-800 mb-2">{t.taskName}</h3>
                          <p className="text-gray-600 text-sm line-clamp-2">{t.taskComment}</p>
                        </div>
                        {timeData && (
                          <span
                            className={`${timeData.statusClass} text-white px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap ml-4`}
                          >
                            {timeData.fullText}
                          </span>
                        )}
                      </div>

                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-sm">
                        <div className="flex items-center gap-2">
                          <Calendar className="w-4 h-4 text-gray-400" />
                          <span className="text-gray-600">{new Date(t.taskDate).toLocaleDateString()}</span>
                        </div>
                                             <div className="flex items-center gap-2">
                        <Clock className="w-4 h-4 text-gray-400" />
                        <span className="text-gray-600">{timeStr}</span>
                      </div>

                      <div className="mt-4 flex flex-wrap items-center gap-2 text-sm">
                        {/* Assignee */}
                        <div className="flex items-center gap-2 rounded px-2 py-1 bg-gray-50 border">
                          <User className="w-4 h-4 text-gray-500" />
                          <span className="text-gray-700">{t.taskAssignedName || 'â€”'}</span>
                        </div>

                        {/* Accounts */}
                        {t.accountName && t.accountName.length > 0 && (
                          <div className="flex items-center gap-2 rounded px-2 py-1 bg-purple-50 border">
                            <span className="text-purple-700 text-sm">{t.accountName.join(', ')}</span>
                          </div>
                        )}

                        {/* Contacts */}
                        {t.contactName && t.contactName.length > 0 && (
                          <div className="flex items-center gap-2 rounded px-2 py-1 bg-green-50 border">
                            <span className="text-green-700 text-sm">{t.contactName.join(', ')}</span>
                          </div>
                        )}
                      </div>

                      <div className="mt-4 flex gap-3">
                        <button
                          className="rounded-md bg-blue-600 px-3 py-1 text-white"
                          onClick={() => openViewModal(t)}
                        >
                          View
                        </button>

                        <button
                          className="rounded-md bg-yellow-500 px-3 py-1 text-white"
                          onClick={() => openEditModal(t)}
                        >
                          Edit
                        </button>

                        <button
                          className="rounded-md bg-red-600 px-3 py-1 text-white"
                          onClick={() => deleteTask(t.taskId, t)}
                        >
                          Delete
                        </button>
                      </div>
                    </div>
                  </div>
                )
              })}
            </div>

            {/* Pagination / More button */}
            <div className="mt-6 flex justify-center">
              {!showAll && hasMore ? (
                <button
                  onClick={() => setShowAll(true)}
                  className="rounded-md bg-gray-200 px-4 py-2 hover:bg-gray-300"
                >
                  More
                </button>
              ) : hasMore ? (
                <button
                  onClick={() => setShowAll(false)}
                  className="rounded-md bg-gray-200 px-4 py-2 hover:bg-gray-300"
                >
                  Show Less
                </button>
              ) : null}
            </div>
          </>
        )}
      </div>

      {/* Add / Edit Modal */}
      {isModalOpen && (
        <Dialog.Root open={isModalOpen} onOpenChange={setModalOpen}>
          <Dialog.Portal>
            <Dialog.Overlay className="fixed inset-0 z-40 bg-black/40 backdrop-blur-sm" />
            <Dialog.Content className="fixed left-1/2 top-1/2 z-50 w-full max-w-2xl -translate-x-1/2 -translate-y-1/2 rounded-xl bg-white p-6 shadow-xl">
              <div className="flex items-center justify-between mb-4">
                <Dialog.Title className="text-xl font-semibold">
                  {editTask ? 'Update Task' : 'Add Task'}
                </Dialog.Title>
                <Dialog.Close asChild>
                  <button className="text-gray-500 hover:text-gray-800">
                    <X className="w-5 h-5" />
                  </button>
                </Dialog.Close>
              </div>

              <div className="grid grid-cols-1 gap-3">
                {/* Assign To - reuse your assignee dropdown */}
                <label className="text-sm font-medium">Assign To</label>
                <div className="relative">
                  <Search className="absolute left-3 top-3 w-4 h-4 text-gray-400" />
                  <Input
                    ref={inputRef}
                    type="text"
                    placeholder="Search assignee..."
                    value={query}
                    onChange={handleInputChange}
                    className="pl-10 pr-4 py-2"
                  />
                  {isOpen && query.length > 0 && (
                    <ul className="absolute z-30 mt-1 max-h-48 w-full overflow-auto rounded-md bg-white py-1 text-base shadow ring-1 ring-black/5">
                      {loadingSearch ? (
                        <li className="p-2 text-gray-600">Loading...</li>
                      ) : assigneeResults.length > 0 ? (
                        assigneeResults.map((a) => (
                          <li
                            key={a.value}
                            className="cursor-pointer p-2 hover:bg-prism-primary hover:text-white"
                            onClick={() => handleAssigneeSelect(a)}
                          >
                            {a.text}
                          </li>
                        ))
                      ) : (
                        <li className="p-2 text-gray-600">No results</li>
                      )}
                    </ul>
                  )}
                </div>

                {/* Due date + time */}
                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm font-medium">Due Date</label>
                    <div className="flex items-center gap-2">
                      <DatePicker
                        selected={dueDate}
                        onChange={(d: Date | null) => setDueDate(d)}
                        className="w-full rounded border p-2"
                      />
                      <Calendar className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>

                  <div>
                    <label className="text-sm font-medium">Time</label>
                    <div className="flex items-center gap-2">
                      <input
                        type="time"
                        value={timeStr}
                        onChange={(e) => setTimeStr(e.target.value)}
                        className="w-full rounded border p-2"
                      />
                      <Clock className="w-5 h-5 text-gray-400" />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-2 gap-3">
                  <div>
                    <label className="text-sm font-medium">Task Type</label>
                    <select
                      value={taskType}
                      onChange={(e) => setTaskType(e.target.value)}
                      className="w-full rounded border p-2"
                    >
                      <option value="">-- Select --</option>
                      <option value="Call Back1">Call Back1</option>
                      <option value="Action items">Action Items</option>
                      <option value="Others">Others</option>
                      <option value="Schedule Meeting">Schedule Meeting</option>
                    </select>
                  </div>

                  <div>
                    <label className="text-sm font-medium">Status</label>
                    <select
                      value={status}
                      onChange={(e) => setStatus(e.target.value)}
                      className="w-full rounded border p-2"
                    >
                      <option value="">-- Select --</option>
                      <option value="Not Started">Not Started</option>
                      <option value="Completed">Completed</option>
                      <option value="In Progress">In Progress</option>
                    </select>
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium">Subject</label>
                  <input
                    type="text"
                    value={subject}
                    onChange={(e) => setSubject(e.target.value)}
                    className="w-full rounded border p-2"
                  />
                </div>

                {/* Contacts chips + input */}
                <div>
                  <label className="text-sm font-medium mb-1 block">Contacts</label>
                  <div className="relative">
                    <div className="flex flex-wrap gap-2 items-center rounded border p-2 bg-gray-50">
                      {contacts.map((contactId) => {
                        const idx = contacts.indexOf(contactId)
                        const name = contactNames[idx] || contactId
                        return (
                          <span
                            key={contactId}
                            className="flex items-center gap-2 rounded bg-blue-100 px-2 py-1 text-sm"
                          >
                            <span>{name}</span>
                            <button
                              type="button"
                              onClick={() => removeContact(contactId)}
                              className="text-blue-700 hover:text-blue-900"
                            >
                              &times;
                            </button>
                          </span>
                        )
                      })}

                      <Input
                        type="text"
                        placeholder="Search and add contacts..."
                        value={contactQuery}
                        onChange={handleContactInputChange}
                        onFocus={() => setIsContactResultsOpen(true)}
                        className="flex-1 min-w-[160px] border-none bg-transparent p-0"
                      />
                    </div>

                    {/* Contact results dropdown */}
                    {isContactResultsOpen && (contactQuery.length > 0 || contactResults.length > 0) && (
                      <ul className="absolute z-40 mt-1 max-h-44 w-full overflow-auto rounded-md bg-white py-1 text-base shadow ring-1 ring-black/5">
                        {loadingContacts ? (
                          <li className="p-2 text-gray-600">Loading...</li>
                        ) : contactResults.length > 0 ? (
                          contactResults.map((c) => (
                            <li
                              key={c.value}
                              className="cursor-pointer p-2 hover:bg-prism-primary hover:text-white"
                              onClick={() => handleContactSelect(c)}
                            >
                              <div className="font-medium">{c.text}</div>
                              {c.account_name && <div className="text-xs text-gray-500">{c.account_name}</div>}
                            </li>
                          ))
                        ) : (
                          <li className="p-2 text-gray-600">No contacts found</li>
                        )}
                      </ul>
                    )}
                  </div>
                </div>

                <div>
                  <label className="text-sm font-medium">Description</label>
                  <textarea
                    value={description}
                    onChange={(e) => setDescription(e.target.value)}
                    rows={3}
                    className="w-full rounded border p-2"
                  />
                </div>
              </div>

              <div className="mt-4 flex justify-end gap-3">
                <Dialog.Close asChild>
                  <button className="rounded-md bg-gray-200 px-4 py-2">Cancel</button>
                </Dialog.Close>

                <button
                  onClick={editTask ? handleUpdateTask : handleAddTask}
                  className="rounded-md bg-blue-600 px-4 py-2 text-white"
                >
                  {editTask ? 'Update' : 'Add'}
                </button>
              </div>
            </Dialog.Content>
          </Dialog.Portal>
        </Dialog.Root>
      )}
      {selectedTask && (
        <ViewTaskModal isOpen={isViewModalOpen} onClose={closeViewModal} task={selectedTask} />
      )}
    </div>
  )
}
