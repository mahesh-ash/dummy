import React, { useRef, useState, useMemo, useEffect } from 'react';
import { AsyncTypeahead } from 'react-bootstrap-typeahead';
import { AgGridReact } from '@ag-grid-community/react';
import { ColumnsToolPanelModule } from '@ag-grid-enterprise/column-tool-panel';
import { SetFilterModule } from '@ag-grid-enterprise/set-filter';
import { MenuModule } from '@ag-grid-enterprise/menu';
import { ClientSideRowModelModule } from '@ag-grid-community/client-side-row-model';
import { Eye, Pencil, Trash2, Plus, Download, CircleDot, CheckCircle2, Clock, RefreshCcw, RefreshCcwIcon } from 'lucide-react';
import { Menu, MenuItem } from 'react-bootstrap-typeahead';
import { ChevronDownCircle } from 'lucide-react';
import httpClient from '@/common/helpers/httpClient';
import { Tooltip, TooltipContent, TooltipProvider, TooltipTrigger } from '@/components/ui/tooltip';
import { Sheet, SheetContent, SheetHeader, SheetTitle, SheetFooter } from '@/components/ui/sheet';
import { Button } from '@/components/ui/button';
import { Popover, PopoverContent, PopoverTrigger } from '@/components/ui/popover';
import { Calendar } from '@/components/ui/calendar';
import { CalendarIcon } from 'lucide-react';
import { Form, FormField, FormItem, FormLabel, FormMessage } from '@/components/ui/form';
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from '@/components/ui/select';
import { useForm } from 'react-hook-form';
import { Checkbox } from '@/components/ui/checkbox';
import { Input } from '@/components/ui/input';
import { toast } from 'sonner';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogFooter } from '@/components/ui/dialog';
import { IS_DARK } from '@/store/signals';
import { useSignals } from '@preact/signals-react/runtime';
import { DateRangePicker } from '../common/DateRangePicker';

const defaultColDef = {
	sortable: true,
	editable: false,
	flex: 1,
	filter: 'agTextColumnFilter', // Enable text filter for all columns
	floatingFilter: true,
	cellStyle: {
		whiteSpace: 'nowrap',
		overflow: 'hidden',
		textOverflow: 'ellipsis',
	},
};


const columns = [
	{
		headerName: 'Account Name',
		field: 'accountName',
		// filter: 'agTextColumnFilter',
		filterParams: {
			filterPlaceholder: (params) => {
				return 'Search Account Name';
			},
		},
		lockVisible: true,
	},
	{ headerName: 'Account ID', field: 'accountId', cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
	{ headerName: 'Invoice Date', field: 'date', headerClass: 'justify-center', filter: false, cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' }, // Disable filter for date column
	{ headerName: 'Commission', field: 'commission', cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
	{ headerName: 'Status', field: 'status', cellRenderer: 'StatusCellRenderer', cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
	{ headerName: 'Invoice', field: 'invoice', cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
	{ headerName: 'Notes', field: 'notes' },
	{
		headerName: 'Action',
		field: 'action',
		filter: false,
		sortable: false,
		editable: false,
		menuTabs: [], // disables column menu
		cellRenderer: 'ActionCellRenderer',
		pinned: 'right',
		minWidth: 120,
		maxWidth: 140,
		filter: false,
		sortable: false,
		lockVisible: true,
		suppressHeaderMenuButton: true,
		cellStyle: { display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '0.5rem' },
	},
];

const dummyData = [
	{
		product: 'Alpha Fund',
		date: '10/01/2025',
		accountName: 'John Doe',
		accountId: 'ACC123',
		commission: '$1,000',
		status: 'Open',
		invoice: 'INV-001',
		notes: 'First payment',
	},
	{
		product: 'Beta Trust',
		date: '11/02/2025',
		accountName: 'Jane Smith',
		accountId: 'ACC456',
		invoiceFile: null,
		commission: '$2,500',
		status: 'Open',
		invoice: 'INV-002',
		notes: 'Awaiting approval',
	},
	{
		product: 'Gamma Equity',
		date: '10/01/2025',
		accountName: 'Acme Corp',
		accountId: 'ACC789',
		commission: '$3,200',
		status: 'Paid',
		invoice: 'INV-003',
		notes: 'Quarterly',
	},
	{
		product: 'Delta Income',
		date: '10/01/2025',
		accountName: 'Global Partners',
		accountId: 'ACC321',
		commission: '$1,800',
		status: 'Paid',
		invoice: 'INV-004',
		notes: 'Annual',
	},
	{
		product: 'Omega Growth',
		date: '10/01/2025',
		accountName: 'Jane Smith',
		accountId: 'ACC654',
		commission: '$2,100',
		status: 'Open',
		invoice: 'INV-005',
		notes: 'Follow up',
	},
	{
		product: 'Sigma Value',
		date: '10/01/2025',
		accountName: 'John Doe',
		accountId: 'ACC987',
		commission: '$950',
		status: 'Paid',
		invoice: 'INV-006',
		notes: 'Late fee applied',
	},
	{
		product: 'Zeta Fund',
		date: '10/01/2025',
		accountName: 'Acme Corp',
		accountId: 'ACC852',
		commission: '$1,500',
		status: 'Open',
		invoice: 'INV-007',
		notes: 'New client',
	},
	{
		product: 'Theta Income',
		date: '10/01/2025',
		accountName: 'Global Partners',
		accountId: 'ACC741',
		commission: '$2,800',
		status: 'Paid',
		invoice: 'INV-008',
		notes: 'Bonus included',
	},
	{
		product: 'Lambda Trust',
		date: '10/01/2025',
		accountName: 'Jane Smith',
		accountId: 'ACC159',
		commission: '$1,200',
		status: 'Paid',
		invoice: 'INV-009',
		notes: 'Quarterly',
	},
	{
		product: 'Pi Equity',
		date: '10/01/2025',
		accountName: 'John Doe',
		accountId: 'ACC357',
		commission: '$2,000',
		status: 'Open',
		invoice: 'INV-010',
		notes: 'Awaiting docs',
	},
];

// const watchedStatus = form.watch("status");
function DefaultCellRenderer(props) {
	const col = props.colDef;
	// Custom Invoice column renderer with download icon on hover
	if (col.field === 'invoice') {
		return (
			<div className={col.className + ' relative flex items-center'} style={col.cellStyle} title={props.value}>
				<span>{props.value}</span>

				<button
					type="button"
					className="ml-2 text-blue-500 hover:text-blue-700 transition-colors"
					style={{ background: 'none', border: 'none', cursor: 'pointer' }}
					title="Download Invoice"
					onClick={() => {
						toast.success('Download Completed');
						/* TODO: implement download logic if needed */
					}}
				>
					<Download size={18} />
				</button>
			</div>
		);
	}
	return (
		<div className={col.className} style={col.cellStyle} title={props.value}>
			{props.value}
		</div>
	);
}

function StatusCellRenderer(props) {
	const status = props.value;
	const isDark = IS_DARK.value;
	let color = isDark ? 'bg-gray-800 text-gray-200' : 'bg-gray-200 text-gray-800';
	let icon = <CircleDot size={16} className={isDark ? 'mr-1 text-gray-400' : 'mr-1'} />;
	if (status === 'Open') {
		color = isDark ? 'bg-yellow-900 text-yellow-200' : 'bg-yellow-100 text-yellow-800';
		icon = <Clock size={16} className={isDark ? 'mr-1 text-yellow-300' : 'mr-1 text-yellow-600'} />;
	}
	if (status === 'Paid') {
		color = isDark ? 'bg-green-900 text-green-200' : 'bg-green-100 text-green-800';
		icon = <CheckCircle2 size={16} className={isDark ? 'mr-1 text-green-300' : 'mr-1 text-green-600'} />;
	}
	if (status === 'Pending') {
		color = isDark ? 'bg-blue-900 text-blue-200' : 'bg-blue-100 text-blue-800';
		icon = <CircleDot size={16} className={isDark ? 'mr-1 text-blue-300' : 'mr-1 text-blue-600'} />;
	}
	return (
		<span className={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold gap-1 ${color}`} style={{ minWidth: 80 }}>
			{icon}
			{status}
		</span>
	);
}

export default function ManageInvoiceTable(props) {
	// Typeahead for Account Name
	useSignals();
	const dummyAccounts = [
		{ accountName: 'John Doe', id: 'ACC123' },
		{ accountName: 'Jane Smith', id: 'ACC456' },
		{ accountName: 'Acme Corp', id: 'ACC789' },
		{ accountName: 'Global Partners', id: 'ACC321' },
	];
	const [accountOptions, setAccountOptions] = useState(dummyAccounts);
	const [accountQuery, setAccountQuery] = useState('');
	const [selectedAccount, setSelectedAccount] = useState([]);

	// Dummy search for Account Name
	function handleAccountSearch(query) {
		setAccountQuery(query);
		setAccountOptions(dummyAccounts.filter((opt) => opt.accountName.toLowerCase().includes(query.toLowerCase())));
	}

	function dateRangeHandler(fromDate, toDate) {}
	function dateRangeCancelHandler() {}
	function handleAccountChange(selected) {
		setSelectedAccount(selected);
		setCoverageRows([
			{ name: 'John Doe', role: 'Manager', coverageStart: '2025/01/01', coverageEnd: '2025/12/31', percentage: 0 },
			{ name: 'Jane Smith', role: 'Analyst', coverageStart: '2025/03/01', coverageEnd: '2025/09/30', percentage: 0 },
		]);
		if (selected.length > 0) {
			form.setValue('accountname', selected[0].accountName);
		}
	}

	// Custom menu renderer for typeahead
	function renderAccountMenu(results, menuProps) {
		if (accountQuery.length === 0 && accountOptions.length === 0) {
			return null;
		}
		const items = results.map((result, index) => {
			if (result.paginationOption) {
				return (
					<MenuItem className="default-menu-item rounded !p-0 justify-center gap-1 text-xm" href="javascript:void();" key={index} option={result}>
						<div>Show More</div>
						<ChevronDownCircle className="size-4 stroke-[#aaa]" />
					</MenuItem>
				);
			} else {
				return (
					<MenuItem className="default-menu-item" href="javascript:void();" key={index} option={result}>
						<div>{result.accountName}</div>
					</MenuItem>
				);
			}
		});
		return (
			<Menu className="default-dropdown" {...menuProps}>
				{items}
			</Menu>
		);
	}
	const gridRef = useRef();
	const [rowData, setRowData] = useState(dummyData);
	const { sheetOpen, setSheetOpen } = props;
	const [showUnsavedDialog, setShowUnsavedDialog] = useState(false);
	const [editingRow, setEditingRow] = useState(null);

	// State for delete dialog
	const [showDeleteDialog, setShowDeleteDialog] = useState(false);
	const [rowToDelete, setRowToDelete] = useState(null);

	// Coverage details table data and columns for Sheet
	const masterCoverageOptions = [
		{ name: 'John Doe', role: 'Manager', coverageStart: '2025/01/01', coverageEnd: '2025/12/31' },
		{ name: 'Jane Smith', role: 'Analyst', coverageStart: '2025/03/01', coverageEnd: '2025/09/30' },
		{ name: 'Acme Corp', role: 'Partner', coverageStart: '2025/05/01', coverageEnd: '2025/11/30' },
	];

	const [search, setSearch] = useState('');
	const [showDropdown, setShowDropdown] = useState(false);
	const [selectedCoverage, setSelectedCoverage] = useState(null);
	const [percentage, setPercentage] = useState('');
	const [coverageRows, setCoverageRows] = useState([]);
	const [coverageError, setCoverageError] = useState('');
	const [percentageInputError, setPercentageInputError] = useState('');

	const filteredOptions = masterCoverageOptions.filter((opt) => opt.name.toLowerCase().includes(search.toLowerCase()));
	useEffect(() => {
		if (percentageInputError != '') {
			toast.error(percentageInputError);
		}
	}, [percentageInputError]);

	const coverageColumns = [
		{ headerName: 'Name', field: 'name', flex: 1, cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
		{ headerName: 'Role', field: 'role', flex: 1, cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
		{ headerName: 'Coverage Start', field: 'coverageStart', flex: 1, cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
		{ headerName: 'Coverage End', field: 'coverageEnd', flex: 1, cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis' },
		{
			headerName: '30% Payout',
			field: 'payout30',
			flex: 1,
			cellRenderer: (params) => (
				<input
					type="checkbox"
					checked={!!params.value}
					onChange={(e) => {
						params.node.setDataValue('payout30', e.target.checked);
					}}
					style={{ width: 18, height: 18 }}
				/>
			),
			cellClass: 'justify-center',
			minWidth: 60,
			maxWidth: 80,
		},
		{
			headerName: 'Percentage',
			field: 'percentage',
			flex: 1,
			editable: true,
			cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis',
			cellEditor: 'agNumberCellEditor',
			cellEditorParams: {
				min: 0,
				max: 100,
			},
		},
		{
			headerName: 'Action',
			field: 'action',
			flex: 1,
			cellClass: 'justify-center whitespace-nowrap overflow-hidden text-ellipsis',
			minWidth: 100,
			filter: false,
			sortable: false,
			headerClass: 'justify-center-custom',
			lockVisible: true,
			suppressHeaderMenuButton: true,
			maxWidth: 120,
			cellRenderer: function CoverageActionCellRenderer(params) {
				return (
					<div style={{ display: 'flex', gap: '0.5rem', justifyContent: 'center' }}>
						<span style={{ cursor: 'pointer', color: '#999' }} title="Delete" onClick={() => params.context.onDeleteCoverage(params.data)}>
							<Trash2 size={18} strokeWidth={1.5} />
						</span>
					</div>
				);
			},
		},
	];

	function handleEditCoverage(row) {
		setSelectedCoverage({ name: row.name, role: row.role, coverageStart: row.coverageStart, coverageEnd: row.coverageEnd });
		setPercentage(row.percentage.toString());
		setCoverageRows((prev) => prev.filter((r) => r.name !== row.name));
	}

	function handleDeleteCoverage(row) {
		setCoverageRows((prev) => prev.filter((r) => r.name !== row.name));
	}

	function handleAddCoverage() {
		if (!selectedCoverage) {
			setCoverageError('Please select a coverage name.');
			return;
		}
		if (percentage === '' || isNaN(Number(percentage))) {
			setCoverageError('Please enter a valid percentage.');
			return;
		}
		const pct = Math.max(0, Math.min(100, Number(percentage)));
		if (coverageRows.some((row) => row.name === selectedCoverage.name)) {
			setCoverageError('This coverage is already added.');
			return;
		}
		setCoverageRows((prev) => [...prev, { ...selectedCoverage, percentage: pct }]);
		setSelectedCoverage(null);
		setSearch('');
		setPercentage('');
		setCoverageError('');
		setPercentageInputError('');
	}

	const defaultValues = {
		invoiceDate: '',
		invoiceNumber: '',
		accountname: '',
		status: '',
		commission: '',
		includeClientsNotAssigned: false,
		includeDeletedClients: false,
		product: '',
		invoiceFile: null,
		notes: '',
	};

	// Add useForm for shadcn Form context
	const form = useForm({
		mode: 'onChange',
		defaultValues: defaultValues,
	});

	const watchedStatus = form.watch("status");

	// Populate form when editingRow changes
	useEffect(() => {
		if (editingRow) {
			form.reset({
				accountname: editingRow.accountName || '',
				invoiceDate: editingRow.date,
				invoiceNumber: editingRow.invoice || '',
				status: editingRow.status || '',
				commission: editingRow.commission ? editingRow.commission.replace(/[^\d.]/g, '') : '',
				includeClientsNotAssigned: false,
				includeDeletedClients: false,
				product: editingRow.product || '',
				invoiceFile: editingRow.invoiceFile || null,
				notes: editingRow.notes || '',
			});
			setSelectedAccount(editingRow.accountName ? [{ accountName: editingRow.accountName }] : []);
			setSheetOpen(true);
		}
	}, [editingRow]);

	function cellEditingStopped(e) {
		if (e.colDef.field === 'percentage') {
			// ag-Grid passes the new value in e.value, but if valueSetter clamps it, use e.newValue
			let attemptedValue = e.newValue !== undefined ? Number(e.newValue) : Number(e.value);
			if (!isNaN(attemptedValue) && attemptedValue > 100) {
				toast.error('Percentage cannot be more than 100.');
			}
		}
	}

	const sideBar = useMemo(
		() => ({
			toolPanels: [
				{
					id: 'columns',
					labelDefault: 'Columns',
					labelKey: 'columns',

					iconKey: 'columns',
					toolPanel: 'agColumnsToolPanel',
					toolPanelParams: {
						suppressRowGroups: true,
						suppressValues: true,
						suppressPivotMode: true,
						suppressColumnFilter: true,
						suppressColumnSelectAll: true,
						suppressColumnExpandAll: true,
					},
				},
			],
			defaultToolPanel: '',
		}),
		[]
	);

	// ActionCellRenderer for ag-Grid Action column
	function ActionCellRenderer(params) {
		const row = params.data;
		return (
			<TooltipProvider>
				<div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
					<Tooltip>
						<TooltipTrigger asChild>
							<button className="text-gray-400" style={{ background: 'none', border: 'none', cursor: 'pointer' }} onClick={() => setEditingRow(row)}>
								<Pencil size={18} />
							</button>
						</TooltipTrigger>
						<TooltipContent>Edit</TooltipContent>
					</Tooltip>
					<span style={{ color: '#d1d5db', fontWeight: 'bold', fontSize: '18px', userSelect: 'none' }}>|</span>
					<Tooltip>
						<TooltipTrigger asChild>
							<button
								className="text-gray-400"
								style={{ background: 'none', border: 'none', cursor: 'pointer' }}
								onClick={() => {
									setRowToDelete(row);
									setShowDeleteDialog(true);
								}}
							>
								<Trash2 size={18} />
							</button>
						</TooltipTrigger>
						<TooltipContent>Delete</TooltipContent>
					</Tooltip>
				</div>
			</TooltipProvider>
		);
	}

	// Track last sheet open state to detect close intent
	const prevSheetOpenRef = useRef(sheetOpen);
	useEffect(() => {
		// Detect close intent (sheetOpen goes from true to false)
		if (prevSheetOpenRef.current && !sheetOpen && form.formState.isDirty) {
			setShowUnsavedDialog(true);
			// Re-open the sheet until dialog resolves
			setSheetOpen(true);
		}
		prevSheetOpenRef.current = sheetOpen;
	}, [sheetOpen, form.formState.isDirty]);

	// Always reset form when sheet is closed (regardless of dirty state)
	useEffect(() => {
		if (!sheetOpen) {
			form.reset(defaultValues);
			setSelectedAccount([]);
			setCoverageRows([]);
			setEditingRow(null);
		}
	}, [sheetOpen]);

	// Custom handler for Sheet open/close
	function handleSheetOpenChange(nextOpen) {
		if (!nextOpen && form.formState.isDirty) {
			setShowUnsavedDialog(true);
			// Keep sheet open until dialog resolves
			setSheetOpen(true);
		} else {
			setSheetOpen(nextOpen);
		}
	}

	function handleDialogConfirm() {
		setShowUnsavedDialog(false);
		setSheetOpen(false);
		form.reset();
		setEditingRow(null);
	}
	function handleDialogCancel() {
		setShowUnsavedDialog(false);
		setSheetOpen(true);
	}

	// Handler for confirming delete
	function handleDeleteConfirm() {
		setShowDeleteDialog(false);
		if (rowToDelete) {
			setRowData((prev) => prev.filter((row) => row !== rowToDelete));
			setRowToDelete(null);
		}
		toast.success('Record deleted successfully');
	}
	function handleDeleteCancel() {
		setShowDeleteDialog(false);
		setRowToDelete(null);
	}

	// Save handler for form
	function handleFormSubmit(data) {
		// If editing, update the row, else add new
		if (editingRow) {
			setRowData((prev) =>
				prev.map((row) =>
					row === editingRow
						? {
								...editingRow,
								...data,
								accountName: data.accountname,
								invoice: data.invoiceNumber,
								date: data.invoiceDate,
								status: data.status,
								commission: `$${data.commission}`,
								notes: data.notes,
								product: data.product,
								invoiceFile: data.invoiceFile,
							}
						: row
				)
			);
		} else {
			setRowData((prev) => [
				...prev,
				{
					product: data.product,
					date: data.invoiceDate,
					accountName: data.accountname,
					accountId: '',
					commission: `$${data.commission}`,
					status: data.status,
					invoice: data.invoiceNumber,
					notes: data.notes,
					invoiceFile: data.invoiceFile || null,
				},
			]);
		}
		setSheetOpen(false);
		form.reset();
		setEditingRow(null);
	}

	return (
		<div className="w-full">
			<Sheet open={sheetOpen} onOpenChange={handleSheetOpenChange}>
				<SheetContent className="sm:max-w-6xl">
					<SheetHeader>
						<SheetTitle>Add Invoice</SheetTitle>
					</SheetHeader>
					{/* Unsaved changes dialog using shadcn Dialog */}
					<Dialog open={showUnsavedDialog} onOpenChange={setShowUnsavedDialog}>
						<DialogContent>
							<DialogHeader>
								<DialogTitle>Unsaved Changes</DialogTitle>
							</DialogHeader>
							<div className="mb-6">You have unsaved changes. Are you sure you want to close?</div>
							<DialogFooter className="flex justify-end gap-2">
								<Button variant="outline" onClick={handleDialogCancel}>
									Cancel
								</Button>
								<Button variant="destructive" onClick={handleDialogConfirm}>
									Discard & Close
								</Button>
							</DialogFooter>
						</DialogContent>
					</Dialog>
					<Form {...form}>
						<form className="grid grid-cols-3 gap-6 p-4" onSubmit={form.handleSubmit(handleFormSubmit)}>
							{/* Row 1 */}
							<div>
								<FormField
									control={form.control}
									name="accountname"
									rules={{ required: 'Account Name is required' }}
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Account Name<span className="text-red-500">*</span></FormLabel>
											<div style={{ position: 'relative' }}>
												<AsyncTypeahead
													id="account-typeahead"
													labelKey="accountName"
													options={accountOptions}
													minLength={1}
													placeholder="Search Account Name"
													onSearch={handleAccountSearch}
													onChange={handleAccountChange}
													selected={selectedAccount}
													inputProps={{
														className: 'h-11 w-full border rounded-md px-3 py-2 text-base focus:outline-none focus:ring-1 placeholder:text-gray-400',
														required: true,
													}}
													menuStyle={{
														zIndex: 1050,
														width: '100%',
														position: 'absolute',
													}}
													renderMenu={renderAccountMenu}
												/>
											</div>
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>
							<div>
								<FormField
									control={form.control}
									name="invoiceDate"
									rules={{ required: 'Invoice Date is required' }}
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Invoice Date<span className="text-red-500">*</span></FormLabel>
											<Popover>
												<PopoverTrigger asChild>
													<Button
														variant="outline"
														className={'w-full justify-start text-left font-normal h-11' + (field.value ? '' : ' text-muted-foreground')}
													>
														<CalendarIcon className="mr-2 h-4 w-4" />
														{field.value ? field.value : <span>Pick a date</span>}
													</Button>
												</PopoverTrigger>
												<PopoverContent className="w-auto p-0">
													<Calendar
														mode="single"
														selected={field.value ? new Date(field.value) : undefined}
														onSelect={(date) => field.onChange(date ? date.toISOString().slice(0, 10) : '')}
														initialFocus
													/>
												</PopoverContent>
											</Popover>
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>

							{/* Row 2 */}
							<div>
								<FormField
									control={form.control}
									name="invoiceNumber"
									rules={{ required: 'Invoice Number is required' }}
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Invoice Number<span className="text-red-500">*</span></FormLabel>
											<Input
												{...field}
												type="text"
												maxLength={256}
												className="focus:outline-none focus:ring-2 focus:ring-primary h-11"
												placeholder="Enter invoice number"
												required
											/>
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>
							<div>
								<FormField
									control={form.control}
									name="status"
									rules={{ required: 'Invoice Status is required' }}
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Invoice Status<span className="text-red-500">*</span></FormLabel>
											<Select value={field.value} onValueChange={field.onChange} disabled={field.disabled} required>
												<SelectTrigger className="w-full justify-between h-11">
													<SelectValue placeholder="Select status" />
												</SelectTrigger>
												<SelectContent>
													<SelectItem value="Open">Open</SelectItem>
													<SelectItem value="Paid">Paid</SelectItem>
												</SelectContent>
											</Select>
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>

							{/* Row 3 */}
							<div>
								<FormField
									control={form.control}
									name="commission"
									rules={{ required: 'Commission is required' }}
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Commission<span className="text-red-500">*</span></FormLabel>
											<Input
												{...field}
												type="number"
												step="any"
												className="w-full focus:outline-none focus:ring-2 focus:ring-primary h-11"
												placeholder="Enter commission amount"
												required
											/>
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>

							<div className="flex flex-col gap-2 justify-end">
								<FormField
									control={form.control}
									name="includeClientsNotAssigned"
									render={({ field }) => (
										<FormItem className="flex flex-row items-center space-x-2">
											<Checkbox id="includeClientsNotAssigned" checked={field.value} onCheckedChange={field.onChange} />
											<FormLabel htmlFor="includeClientsNotAssigned" className="font-medium cursor-pointer">
												Include Clients not Assigned
											</FormLabel>
										</FormItem>
									)}
								/>
								<FormField
									control={form.control}
									name="includeDeletedClients"
									render={({ field }) => (
										<FormItem className="flex flex-row items-center space-x-2">
											<Checkbox id="includeDeletedClients" checked={field.value} onCheckedChange={field.onChange} />
											<FormLabel htmlFor="includeDeletedClients" className="font-medium cursor-pointer">
												Include Deleted Clients
											</FormLabel>
										</FormItem>
									)}
								/>
							</div>

							<div>
								<FormField
									control={form.control}
									name="status"
									rules={{ required: 'choose Syndicate or invoice' }}
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Product<span className="text-red-500">*</span></FormLabel>
											<Select value={field.value} onValueChange={field.onChange} disabled={field.disabled} required>
												<SelectTrigger className="w-full justify-between h-11">
													<SelectValue placeholder="Select status" />
												</SelectTrigger>
												<SelectContent>
													<SelectItem value="Open">Syndicate</SelectItem>
													<SelectItem value="Paid">Invoice</SelectItem>
												</SelectContent>
											</Select>
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>
							 {watchedStatus === 'Open' && (
                <div className="col-span-3 grid grid-cols-2 gap-6 mt-6">
                    <div className="col-span-2 bg-gray-50 dark:bg-gray-800 rounded-lg p-4 grid grid-cols-4 gap-4 mb-4">
                        <FormField
                            control={form.control}
                            name="ticker"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel className="font-medium">Ticker</FormLabel>
                                    <Input {...field} type="text" maxLength={32} className="h-10" placeholder="Ticker" />
                                    <FormMessage />
                                </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="quantity"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel className="font-medium">Quantity</FormLabel>
                                    <Input {...field} type="number" min={0} className="h-10" placeholder="Quantity" />
                                    <FormMessage />
                                </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="price"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel className="font-medium">Price</FormLabel>
                                    <Input {...field} type="number" min={0} step="any" className="h-10" placeholder="Price" />
                                    <FormMessage />
                                </FormItem>
                            )}
                        />
                        <FormField
                            control={form.control}
                            name="netAmount"
                            render={({ field }) => (
                                <FormItem>
                                    <FormLabel className="font-medium">Net Amount</FormLabel>
                                    <Input {...field} type="number" min={0} step="any" className="h-10" placeholder="Net Amount" />
                                    <FormMessage />
                                </FormItem>
                            )}
                        />
                    </div>
                </div>
            )}

							<div className="col-span-3 grid grid-cols-2 gap-6">
								<FormField
									control={form.control}
									name="invoiceFile"
									render={({ field }) => (
										<FormItem>
											<FormLabel className="font-medium">Attach Invoice<span className="text-red-500">*</span></FormLabel>
											<div
												className="border-2 border-dashed dark:border-gray-800 border-gray-300 rounded-lg p-4 dark:bg-inherit flex flex-col items-center justify-center bg-gray-50 hover:bg-gray-100 transition h-[115px] cursor-pointer relative"
												onClick={() => document.getElementById('invoiceFileInput')?.click()}
											>
												<input
													type="file"
													id="invoiceFileInput"
													accept=".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx"
													className="hidden"
													onChange={(e) => field.onChange(e.target.files && e.target.files[0])}
												/>
												{field.value ? (
													<div className="flex flex-col items-center w-full">
														<span className="text-sm text-gray-700 truncate max-w-xs">{field.value.name}</span>
														<Button
															type="button"
															variant="outline"
															size="sm"
															className="mt-2"
															onClick={(e) => {
																e.stopPropagation();
																field.onChange(null);
															}}
														>
															Remove
														</Button>
													</div>
												) : (
													<span className="text-gray-400 text-sm">Drag & drop or click to upload (PDF, Word, PPT, XLS)</span>
												)}
											</div>
											<FormMessage />
										</FormItem>
									)}
								/>

								<FormField
									control={form.control}
									name="notes"
									render={({ field }) => (
										<FormItem>
											<FormLabel>Notes</FormLabel>
											<textarea id="notes" rows={4} className="border rounded w-full p-2" placeholder="Enter notes here..." {...field} />
											<FormMessage />
										</FormItem>
									)}
								/>
							</div>
						</form>
					</Form>

					{/* Only visible the coverage details once the Account name selected */}
					{selectedAccount.length >0 && (
					<div className="p-4">
						<h3 className="text-lg font-semibold mb-2">Coverage Details</h3>
						{/* Search input, percentage input, and Add button above table */}

						<div className="mb-4 flex gap-2 items-center" style={{ maxWidth: 500 }}>
							<div style={{ position: 'relative', flex: 2 }}>
								<Input
									value={search}
									onChange={(e) => {
										const newValue = e.target.value;
										setSearch(newValue);
										setShowDropdown(true);
										if (!newValue || (selectedCoverage && newValue !== selectedCoverage.name)) {
                                        setSelectedCoverage(null);
                                        setPercentage(''); 
                                    }

									}}
									onFocus={() => setShowDropdown(true)}
									onBlur={() => setTimeout(() => setShowDropdown(false), 150)}
									placeholder="Search name..."
									className="w-80"
								/>
								{showDropdown && (
									<ul
										className="dark:bg-gray-800 bg-gray-100 border"
										style={{
											position: 'absolute',
											zIndex: 10,
											borderRadius: 4,
											margin: 0,
											padding: 0,
											width: '100%',
											maxHeight: 120,
											overflowY: 'auto',
											listStyle: 'none',
										}}
									>
										{filteredOptions.length > 0 ? (
											filteredOptions.map((opt) => (
												<li
													key={opt.name}
													style={{ padding: '6px 10px', cursor: 'pointer' }}
													onMouseDown={() => {
														setSelectedCoverage(opt);
														setSearch(opt.name);
														setShowDropdown(false);
													}}
												>
													{opt.name}
												</li>
											))
										) : (
											<li style={{ padding: '6px 10px', color: '#888' }}>No matches</li>
										)}
									</ul>
								)}
							</div>
							   {selectedCoverage && ( 
                        <div className="flex items-center mt-2">
							<Input
								value={percentage}
								onChange={(e) => {
									const val = e.target.value.replace(/[^0-9.]/g, '');
									setPercentage(val);
									if (val !== '' && Number(val) > 100) {
										setPercentageInputError('Percentage cannot be more than 100.');
									} else {
										setPercentageInputError('');
									}
								}}
								type="number"
								min={0}
								max={100}
								placeholder="%"
								className="input input-bordered border rounded px-3 py-2 text-base w-24"
								disabled={!selectedCoverage}
							/>
							<Button
								type="button"
								variant="default"
								className="ml-2"
								onClick={handleAddCoverage}
								disabled={!selectedCoverage || percentage === '' || (percentage !== '' && Number(percentage) > 100)}
							>
								Add
							</Button>
						</div>
							   )}
							   </div>
						{coverageRows.length > 0 && (
						
							<div
								className={`${IS_DARK.value ? 'ag-theme-balham-dark' : 'ag-theme-balham'}  coverage-table w-full`}
								style={{ height: 220, minHeight: 120, overflow: 'auto' }}
							>
								<AgGridReact
									columnDefs={coverageColumns}
									rowData={coverageRows}
									rowHeight={34}
									headerHeight={34}
									domLayout="normal"
									modules={[ClientSideRowModelModule]}
									defaultColDef={defaultColDef.filter == ''}
									suppressMovableColumns
									context={{ onEditCoverage: handleEditCoverage, onDeleteCoverage: handleDeleteCoverage }}
									onCellEditingStopped={cellEditingStopped}
									noRowsOverlayComponent={() => <span>Record not found.</span>}
									invalidEditValueMode={'block'}
								/>
							</div>
						)}
					</div>
						)}
					<SheetFooter className="flex flex-row justify-end">
						<Button
							className={`${!form.formState.isValid ? 'opacity-50 cursor-not-allowed' : ''}`}
							ref={null}
							type="submit"
							onClick={form.handleSubmit(handleFormSubmit)}
							// disabled={!form.formState.isValid}
						>
							Save
						</Button>
						<Button variant="outline" type="button" onClick={() => handleSheetOpenChange(false)}>
							Cancel
						</Button>
					</SheetFooter>
				</SheetContent>
			</Sheet>
			<div className="flex justify-between pb-2">
				<DateRangePicker
					onCancel={dateRangeCancelHandler}
					locale="en-US"
					// initialDateFrom={rangeStartDate}
					// initialDateTo={rangeEndDate}
					onUpdate={dateRangeHandler}
					showCompare={false}
				></DateRangePicker>
				<div className="flex gap-2 items-center">
					<span className=" font-medium mr-2">#{rowData.length} Records</span>
					<Button title={'Refresh'} className={'h-[40px]'} variant="outline">
						<RefreshCcwIcon></RefreshCcwIcon>
					</Button>
					<Button onClick={() => toast.success('Download Completed')} title={'Download'} className={'h-[40px] border-custom-border'} variant="outline">
						<Download></Download>
						Excel
					</Button>
				</div>
			</div>
			<div
				className={`${IS_DARK.value ? 'ag-theme-balham-dark' : 'ag-theme-balham'} w-full grid-container invoice-table`}
				style={{ height: 700, minHeight: 300, overflow: 'auto' }}
			>
				<AgGridReact
					ref={gridRef}
					columnDefs={columns.map((col) => {
						if (col.cellRenderer === 'ActionCellRenderer') return { ...col, cellRenderer: ActionCellRenderer };
						if (col.cellRenderer === 'StatusCellRenderer') return { ...col, cellRenderer: StatusCellRenderer };
						return { ...col, cellRenderer: DefaultCellRenderer };
					})}
					defaultColDef={defaultColDef}
					rowData={rowData}
					modules={[ColumnsToolPanelModule, SetFilterModule, MenuModule, ClientSideRowModelModule]}
					rowHeight={40}
					headerHeight={40}
					domLayout="normal"
					sideBar={sideBar}
					suppressMovableColumns
					noRowsOverlayComponent={() => <span>Record not found.</span>}
				/>
			</div>
			{/* Delete warning dialog using shadcn Dialog */}
			<Dialog open={showDeleteDialog} onOpenChange={setShowDeleteDialog}>
				<DialogContent>
					<DialogHeader>
						<DialogTitle>Delete Invoice</DialogTitle>
					</DialogHeader>
					<div className="mb-6">Are you sure you want to delete this invoice? This action cannot be undone.</div>
					<DialogFooter className="flex justify-end gap-2">
						<Button variant="outline" onClick={handleDeleteCancel}>
							Cancel
						</Button>
						<Button variant="destructive" onClick={handleDeleteConfirm}>
							Delete
						</Button>
					</DialogFooter>
				</DialogContent>
			</Dialog>
		</div>
	);
}
--------------------------------------------------------------------------
account_id
string
comm_date
string
comm_no
string
comm_status
string
commission
string
product
string
ticker
string
quantity
string
price
string
payOut
boolean
net_amount
string
comments
string
emp_splits
string-
------------------------------
POST
/commission/SaveCommission
-------------------------------------------------
