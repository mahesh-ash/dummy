import React, { useEffect, useMemo, useRef, useState } from 'react'
import * as Dialog from '@radix-ui/react-dialog'
import { ChevronDownIcon, ChevronUpIcon, EyeIcon, PencilIcon, PlusIcon, Search, Trash2Icon, TrashIcon} from 'lucide-react'
import {  MagnifyingGlassIcon, TableCellsIcon, FunnelIcon } from '@heroicons/react/24/outline';

import DatePicker from 'react-datepicker'

import { Input } from '@/components/ui/input'
import { useToast } from '@/hooks/use-toast'
import { API_CONFIG } from '@/lib/constants'
import { createAuthHeaders } from '@/lib/legacyUtils'
import { prismStorage } from '@/lib/prismStorage'

import 'react-datepicker/dist/react-datepicker.css'

import TimePicker from 'react-time-picker';
import 'react-time-picker/dist/TimePicker.css';
import 'react-clock/dist/Clock.css';
import { 
  useReactTable, 
  getCoreRowModel, 
  getPaginationRowModel, 
  getFilteredRowModel,
  flexRender,
  ColumnDef,
  VisibilityState,
} from '@tanstack/react-table';
import moment from 'moment-timezone';




type TaskItem = {
  taskId: string
  taskName?: string
  taskComment?: string
  taskDate?: string
  taskAssignedName?: string
  taskAssignedId?: string
  taskType?: string
  taskStatus?: string
  contacts?: string[]
  contactName?: string[]
  accountName?: string[]
  taskComments?: string
  reminder?: any[]
}

interface AssigneeOption {
  text?: string
  value?: string
  code?: string
  style?: string
  docName?: string | null
  docId?: string | null
}

interface ContactOption {
  text?: string
  value?: string
  code?: string
  style?: string
  docName?: string | null
  docId?: string | null
  account_name?: string 
}

export default function TasksWidget() {
  const { toast } = useToast()
  const [tasks, setTasks] = useState<TaskItem[]>([])
  const [loading, setLoading] = useState(false)
  const [editTask, setEditTask] = useState<TaskItem | null>(null)
  const [subject, setSubject] = useState('')
  const [assignedTo, setAssignedTo] = useState('')
  const [taskType, setTaskType] = useState('')
  const [status, setStatus] = useState('')
  const [description, setDescription] = useState('')
  const [dueDate, setDueDate] = useState<Date | null>(new Date())
  // const [timeStr, setTimeStr] = useState('10:00')
  const [timeStr, setTimeStr] = useState<string | null>(''); 
  const [query, setQuery] = useState('')
  const [assigneeResults, setAssigneeResults] = useState<AssigneeOption[]>([])
  const [loadingSearch, setLoadingSearch] = useState(false)
  const [isOpen, setIsOpen] = useState(false)
  const [selectedIndex, setSelectedIndex] = useState(-1)
  const [isModalOpen, setModalOpen] = useState(false)
  const inputRef = useRef(null)
  const [assignedToName, setAssignedToName] = useState('')

  const [isViewModalOpen, setIsViewModalOpen] = useState(false)
  const [selectedTask, setSelectedTask] = useState<TaskItem | null>(null)

  const [assignedToId, setAssignedToId] = useState('')

  const [contactNames, setContactNames] = useState<string[]>([])
  const [contacts, setContacts] = useState<string[]>([])
  const [contactQuery, setContactQuery] = useState('')
  const [contactResults, setContactResults] = useState<ContactOption[]>([])
  const [loadingContacts, setLoadingContacts] = useState(false)
  const [isContactResultsOpen, setIsContactResultsOpen] = useState(false)

   const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
  const [taskToDeleteData, setTaskToDeleteData] = useState(null);

   const [showAllTasks, setShowAllTasks] = useState(false);

    const tasksToShow = showAllTasks ? tasks : tasks.slice(0, 3);
  const hasMoreTasks = tasks.length > 3;

  //   const DataTableAllTasks = () => (
  //   <div className="overflow-x-auto mt-4">
  //     <table className="min-w-full divide-y divide-gray-200 shadow-sm rounded-lg overflow-hidden">
  //       <thead className="bg-gray-100">
  //         <tr>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Name</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Type</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Assignee</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Name</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task Comments</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date/Time</th>
  //           <th className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
  //         </tr>
  //       </thead>
  //       <tbody className="bg-white divide-y divide-gray-200">
  //         {tasks.map((t) => (
  //           <tr key={t.taskId} className="hover:bg-gray-50">
  //             <td className="px-3 py-4 whitespace-nowrap">
  //               <div className="flex gap-2">
  //                   {/* View icon was removed in previous requests, just Edit/Delete remain */}
  //                   <button
  //                       className="p-1 text-yellow-600 hover:text-yellow-800"
  //                       onClick={() => openEditModal(t)}
  //                       title="Edit Task"
  //                   >
  //                       <PencilIcon className="h-4 w-4" />
  //                   </button>
  //                   <button
  //                       className="p-1 text-red-600 hover:text-red-800"
  //                       onClick={() => handleDeleteClick(t.taskId, t)}
  //                       title="Delete Task"
  //                   >
  //                       <TrashIcon className="h-4 w-4" />
  //                   </button>
  //               </div>
  //             </td>
  //             <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-900">{t.taskName}</td>
  //             <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-500">{t.taskType}</td>
  //             <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-500">{t.taskAssignedName}</td>
  //             <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-500">{t.contactName?.join(', ') || 'N/A'}</td>
  //             <td className="px-3 py-4 text-sm text-gray-500 truncate max-w-xs">{t.taskComment||'-'}</td>
  //             <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-500">{t.taskDate}</td>
  //             <td className="px-3 py-4 whitespace-nowrap text-sm text-gray-500">{t.taskStatus|| '-'}</td>
  //           </tr>
  //         ))}
  //       </tbody>
  //     </table>
  //   </div>
  // );

  const DataTableAllTasks = ({ tasks, openEditModal, handleDeleteClick }) => {
  const [globalFilter, setGlobalFilter] = useState('');
  const [columnVisibility, setColumnVisibility] = useState<VisibilityState>({});
  const [pageSize, setPageSize] = useState(10); 

  const columns = useMemo<ColumnDef<TaskItem>[]>(
    () => [
      {
        header: 'Action',
        id: 'actions',
        cell: ({ row }) => (
          <div className="flex gap-2">
            <button
              className="p-1 text-yellow-600 hover:text-yellow-800"
              onClick={() => openEditModal(row.original)}
              title="Edit Task"
            >
              <PencilIcon className="h-4 w-4" />
            </button>
            <button
              className="p-1 text-red-600 hover:text-red-800"
              onClick={() => handleDeleteClick(row.original.taskId, row.original)}
              title="Delete Task"
            >
              <TrashIcon className="h-4 w-4" />
            </button>
          </div>
        ),
        enableHiding: false,
      },
      { header: 'Task Name', accessorKey: 'taskName' },
      { header: 'Task Type', accessorKey: 'taskType' },
      { header: 'Assignee', accessorKey: 'taskAssignedName' },
      { header: 'Contact Name', accessorKey: 'contactName', cell: info => info.getValue()?.join(', ') || '-' },
      { header: 'Task Comments', accessorKey: 'taskComment' },
      { header: 'Due Date/Time', accessorKey: 'taskDate' },
      { header: 'Status', accessorKey: 'taskStatus', cell: info => info.getValue() || '-' },
    ],
    [openEditModal, handleDeleteClick]
  );

  const table = useReactTable({
    data: tasks,
    columns,
    state: {
      globalFilter,
      columnVisibility,
      pagination: {
        pageIndex: 0,
        pageSize: pageSize,
      },
    },
    onGlobalFilterChange: setGlobalFilter,
    onColumnVisibilityChange: setColumnVisibility,
    getCoreRowModel: getCoreRowModel(),
    getFilteredRowModel: getFilteredRowModel(),
    getPaginationRowModel: getPaginationRowModel(),
  });

  return (
    <div className="mt-4">
      {/* --- Top Controls (Search, Visibility, Export, Page Size) --- */}
      <div className="flex justify-between items-center mb-4">
        {/* Search Input with Icon */}
        <div className="relative">
            <MagnifyingGlassIcon className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 text-gray-400" />
            <input
                type="text"
                placeholder="Search..."
                value={globalFilter}
                onChange={e => setGlobalFilter(e.target.value)}
                className="pl-10 pr-4 py-2 border rounded-lg w-64 focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
        </div>

        {/* Right side controls group */}
        <div className="flex items-center gap-4">
            {/* Page Size Selector */}
            <select 
                value={pageSize} 
                onChange={e => {
                    setPageSize(Number(e.target.value));
                    table.setPageSize(Number(e.target.value));
                }}
                className="py-2 px-3 border border-gray-300 bg-white rounded-md shadow-sm text-sm"
            >
                <option value={10}>10</option>
                <option value={20}>20</option>
                <option value={50}>50</option>
                <option value={100}>100</option>
            </select>
            
            {/* Export to Excel (Placeholder functionality) */}
            <button onClick={() => alert('Exporting to Excel...')} className="p-2 border rounded-lg bg-gray-100 hover:bg-gray-200" title="Export to Excel">
                <FunnelIcon className='h-4 w-4'/>
            </button>
            
            {/* Change Column Visibility (Placeholder functionality) */}
            <button onClick={() => alert('Implement Column Visibility logic')} className="p-2 border rounded-lg bg-gray-100 hover:bg-gray-200" title="Change column visibility">
                <TableCellsIcon className='h-4 w-4'/>
            </button>
        </div>
      </div>

      {/* --- Table Display --- */}
      <div className="overflow-x-auto shadow-sm rounded-lg border">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-100">
            {table.getHeaderGroups().map(headerGroup => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map(header => (
                  <th
                    key={header.id}
                    className="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    {flexRender(header.column.columnDef.header, header.getContext())}
                  </th>
                ))}
              </tr>
            ))}
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {table.getRowModel().rows.map(row => (
              <tr key={row.id} className="hover:bg-gray-50">
                {row.getVisibleCells().map(cell => (
                  <td key={cell.id} className="px-3 py-4 whitespace-nowrap text-sm text-gray-500">
                    {flexRender(cell.column.columnDef.cell, cell.getContext())}
                  </td>
                ))}
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* --- Bottom Controls (Pagination) --- */}
      <div className="mt-4 flex justify-between items-center">
        <span>
            Showing {Math.min(table.getState().pagination.pageIndex * pageSize + 1, tasks.length)} 
            to {Math.min((table.getState().pagination.pageIndex + 1) * pageSize, tasks.length)} 
            of {tasks.length} entries
        </span>
        <div className="flex gap-2">
          <button
            onClick={() => table.previousPage()}
            disabled={!table.getCanPreviousPage()}
            className="px-4 py-2 border rounded-lg text-sm disabled:opacity-50 hover:bg-gray-100"
          >
            Previous
          </button>
          <button
            onClick={() => table.nextPage()}
            disabled={!table.getCanNextPage()}
            className="px-4 py-2 border rounded-lg text-sm disabled:opacity-50 hover:bg-gray-100"
          >
            Next
          </button>
        </div>
      </div>
    </div>
  );
}


  const handleDeleteClick = (taskId, taskData) => {
    setTaskToDeleteData({ taskId, taskData });
    setIsDeleteModalOpen(true);
  };



  const handleConfirmDelete = async () => {
    if (taskToDeleteData) {
      setIsDeleteModalOpen(false); 
      await deleteTask(taskToDeleteData.taskId, taskToDeleteData.taskData);
      setTaskToDeleteData(null);
    }
  };

  const closeDeleteModal = () => {
    setIsDeleteModalOpen(false);
    setTaskToDeleteData(null);
  };

  const DeleteConfirmationModal = ({ isOpen, onClose, onConfirm }) => {
  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
        <h2 className="text-xl font-bold mb-4 text-gray-800">Delete Task</h2>
        <p className="mb-6 text-gray-600">Are you sure you want to delete this task?</p>
        <div className="flex justify-end gap-3">
          <button
            onClick={onClose}
            className="px-4 py-2 rounded bg-gray-200 text-gray-800 hover:bg-gray-300"
          >
            No
          </button>
          <button
            onClick={onConfirm}
            className="px-4 py-2 rounded bg-red-600 text-white hover:bg-red-700"
          >
            Yes
          </button>
        </div>
      </div>
    </div>
  );
};

  // const openViewModal = (task: TaskItem) => {
  //   setSelectedTask(task)
  //   setIsViewModalOpen(true)
  // }
  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setQuery(e.target.value)
    if (!e.target.value) {
      setIsOpen(false)
    } else {
      setIsOpen(true)
    }
    setSelectedIndex(-1)
    if (!isModalOpen) setModalOpen(true)
  }

  // const closeViewModal = () => {
  //   setIsViewModalOpen(false)
  //   setSelectedTask(null)
  // }

  // interface ViewTaskModalProps {
  //   isOpen: boolean
  //   onClose: () => void
  //   task: TaskItem
  // }

  // const ViewTaskModal: React.FC<ViewTaskModalProps> = ({ isOpen, onClose, task }) => {
  //   return (
  //     <Dialog.Root open={isOpen} onOpenChange={onClose}>
  //       <Dialog.Portal>
  //         <Dialog.Overlay className="fixed inset-0 z-40 bg-black/40 backdrop-blur-sm" />

  //         <Dialog.Content className="fixed left-1/2 top-1/2 z-50 w-full max-w-lg -translate-x-1/2 -translate-y-1/2 rounded-lg bg-white p-6 shadow-xl">
  //           <Dialog.Title className="mb-4 text-2xl font-bold">
  //             Task Details: {task.taskName}
  //           </Dialog.Title>

  //           <div className="space-y-3">
  //             <p>
  //               <strong>Status:</strong> {task.taskStatus}
  //             </p>
  //             <p>
  //               <strong>Due Date:</strong>
  //               {task.taskDate && new Date(task.taskDate).toLocaleString()}
  //             </p>
  //             <p>
  //               <strong>Assignee:</strong> {task.taskAssignedName}
  //             </p>
  //             <p>
  //               <strong>Task Type:</strong> {task.taskType}
  //             </p>
  //             <p>
  //               <strong>Description:</strong> {task.taskComment}
  //             </p>
  //             <p>
  //               <strong>Account:</strong> {task.accountName?.join(', ')}
  //             </p>
  //             <p>
  //               <strong>ContactName:</strong> {task.contactName?.join(', ')}
  //             </p>
  //           </div>

  //           <div className="mt-6 flex justify-end">
  //             <Dialog.Close asChild>
  //               <button onClick={onClose} className="rounded bg-gray-300 px-4 py-2">
  //                 Close
  //               </button>
  //             </Dialog.Close>
  //           </div>
  //         </Dialog.Content>
  //       </Dialog.Portal>
  //     </Dialog.Root>
  //   )
  // }

  const normalizeToArray = (data: any) => (Array.isArray(data) ? data : data ? [data] : [])


  // To fetch tasks from API
  async function fetchTasks() {
    setLoading(true)
    try {
      const summaryFilter = prismStorage.get('summaryFilter') || JSON.stringify({ filter: [] })
      const body = new URLSearchParams({ summaryFilter }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/getTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        setTasks(Array.isArray(data.data) ? data.data : [])

        const rawTasks = Array.isArray(data.data) ? data.data : []
        const normalizedTasks = rawTasks.map((task: any) => {
          const contactIds = task.contactList
            ? task.contactList.map((contactItem: any) => contactItem.contact_id)
            : []

          const contactNames = task.contactList
            ? task.contactList.map((contactItem: any) => contactItem.contact_name)
            : []
          const accountNames = task.contactList
            ? task.contactList.map((contactItem: any) => contactItem.account_name)
            : []
          return {
            ...task,

            contacts: contactIds,
            contactName: contactNames,
            accountName: accountNames,
          }
        })

        setTasks(normalizedTasks)
      } else {
        setTasks([])
      }
    } catch (err) {
      console.error('fetchTasks error', err)
      toast({ title: 'Error', description: 'Failed to fetch tasks' })
    } finally {
      setLoading(false)
    }
  }

  // To fetch full task details by ID

  async function fetchTaskDetails(taskId: string) {
    try {
      const body = new URLSearchParams({ taskId }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/getTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
        }),
        body,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        if (Array.isArray(data.data) && data.data.length > 0) return data.data[0]
        return data.data || null
      }
      return null
    } catch (err) {
      return null
    }
  }

  useEffect(() => {
    fetchTasks()
  }, [])


  // Fetch assignees based on query
  useEffect(() => {
    const timer = setTimeout(async () => {
      if (!query.trim()) {
        setAssigneeResults([])
        return
      }

      setLoadingSearch(true)

      const payload = {
        filtertype: 'employee',
        filterrpttype: 'Outlook',
        showuser: true,
        searchtext: query,
      }

      const queryString = new URLSearchParams(payload).toString()

      const requestUrl = `${API_CONFIG.baseUrl}/userconfig/searchfilters?${queryString}`

      try {
        const res = await fetch(requestUrl, {
          method: 'GET',
          headers: createAuthHeaders({
            Accept: 'application/json, text/javascript, */*; q=0.01',
          }),
          credentials: 'include',
        })

        const data: AssigneeOption[] = await res.json()

        if (Array.isArray(data)) {
          setAssigneeResults(data)
        } else {
          setAssigneeResults([])
        }
      } catch (err) {
        console.error('Fetch assignee error:', err)
        setAssigneeResults([])
      } finally {
        setLoadingSearch(false)
      }
    }, 300)

    return () => clearTimeout(timer)
  }, [query])

  // fetch contacts based on contactQuery
  useEffect(() => {
    const timer = setTimeout(async () => {
      if (!contactQuery.trim()) {
        setContactResults([])
        return
      }

      setLoadingContacts(true)
      const queryString = new URLSearchParams({
        filtertype: 'contact',
        restype: 'Detailed',
        searchtext: contactQuery,
      }).toString()

      const requestUrl = `${API_CONFIG.baseUrl}/userconfig/searchfilters?${queryString}`

      try {
        const res = await fetch(requestUrl, {
          method: 'GET',
          headers: createAuthHeaders({
            Accept: 'application/json, text/javascript, */*; q=0.01',
          }),
          credentials: 'include',
        })

        const data: ContactOption[] = await res.json()

        if (Array.isArray(data)) {
          setContactResults(data)
        } else {
          setContactResults([])
        }
      } catch (err) {
        console.error('Fetch contact error:', err)
        setContactResults([])
      } finally {
        setLoadingContacts(false)
      }
    }, 300)

    return () => clearTimeout(timer)
  }, [contactQuery])

  // Handle contact selection
  const handleContactSelect = (contact: ContactOption) => {
    if (typeof contact.value !== 'string' || typeof contact.text !== 'string' || !contact.value || !contact.text) {
        console.error("Invalid contact data received:", contact);
        return;
    }
    if (!contacts.includes(contact.value)) {
      setContacts((prev) => [...prev, contact.value!])

      setContactNames((prev) => [...prev, contact.text!])
    }
    setContactQuery('')
    setIsContactResultsOpen(false)
  }

  const handleContactInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    setContactQuery(e.target.value)
    setIsContactResultsOpen(true)
  }

  const removeContact = (contactId: string) => {
    setContacts((prev) => prev.filter((id) => id !== contactId))
    setContactNames((prev) => prev.filter((name, index) => contacts[index] !== contactId))
  }

  const handleAssigneeSelect = (assignee: AssigneeOption) => {
    setQuery(assignee.text || '')
    setAssignedToId(assignee.value || '')
    setAssignedToName(assignee.text || '')
    setIsOpen(false)
  }

  // Add new task
  async function handleAddTask() {
    try {

      const isEmpty = (value: any) => value === null || value === undefined || (typeof value === 'string' && value.trim() === '') || (Array.isArray(value) && value.length === 0);

      const mandatoryFields = [
        { value: assignedToId, name: 'Assignee' },
        { value: subject, name: 'Subject' },
        { value: dueDate, name: 'Due Date' },
        { value: timeStr, name: 'Time' },
        { value: taskType, name: 'Task Type' },
        { value: status, name: 'Status' },
        { value: contacts, name: 'Contacts' }, 
      ];

       const missingField = mandatoryFields.find(field => isEmpty(field.value));

      if (missingField) {
        toast({ 
          title: 'Validation Error', 
          description: `The mandatory field "${missingField.name}" is missing. Please fill out all required fields.` 
        });
        return; 
      }

      if (!assignedToId.trim()) {
        toast({ title: 'Validation', description: 'Assignee required' })
        return
      }
      if (!subject.trim()) {
        toast({ title: 'Validation', description: 'Subject required' })
        return
      }
      const clienttimezone = encodeURIComponent(moment.tz.guess());

const rawTaskDate = dueDate; 

const formattedDateTime = rawTaskDate ? moment(rawTaskDate, 'YYYY-MM-DD HH:mm:ss.S').format('YYYY-MM-DD HH:mm:ss') : '';

const formattedDueTime = rawTaskDate ?  moment(rawTaskDate, 'YYYY-MM-DD HH:mm:ss.S').format('HH:mm') : '';
      const sanitizedContacts = contacts.filter((id) => id != null && id !== '')
      const sanitizedContactNames = contactNames.filter((name) => name != null && name !== '')

      const payloadObj = {
        subject,
        dueDate: formattedDateTime,
        dueTime: formattedDueTime,
        contacts: sanitizedContacts,
        contactName: sanitizedContactNames,
        assignedTo: assignedToId,
        clienttimezone,
        status,
        taskType,
        taskComments: description,
        module_name: 'Task',
        action: 'Save',
      }
      const encoded = new URLSearchParams({ data: JSON.stringify(payloadObj) }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/addTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body: encoded,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        toast({ title: 'Success', description: 'Task Added Successfully' })
        setModalOpen(false)
        resetForm()
        fetchTasks()
      } else {
        toast({ title: 'Error', description: data?.message || 'Failed to add task' })
      }
    } catch (err) {
      console.error('handleAddTask', err)
      toast({ title: 'Error', description: 'Failed to add task' })
    }
  }

  async function handleUpdateTask() {
    try {
      if (!editTask) return
      const rawTaskDate = dueDate; 
 const clienttimezone = encodeURIComponent(moment.tz.guess());
const formattedDateTime = rawTaskDate ? moment(rawTaskDate, 'YYYY-MM-DD HH:mm:ss.S').format('YYYY-MM-DD HH:mm:ss') : '';
const formattedDueTime = rawTaskDate ?  moment(rawTaskDate, 'YYYY-MM-DD HH:mm:ss.S').format('HH:mm') : '';
      const payloadObj = {
        subject,
        dueDate: formattedDateTime,
        dueTime: formattedDueTime,
        contacts,
        contactName: contactNames,
        assignedTo: assignedToId,
        clienttimezone,
        status,
        taskType,
        taskComments: description,
        module_name: 'Task',
        action: 'Update',
        taskId: editTask.taskId,
      }
      const encoded = new URLSearchParams({ data: JSON.stringify(payloadObj) }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/addTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body: encoded,
        credentials: 'include',
      })
      const data = await res.json()
      if (data?.status === 1) {
        toast({ title: 'Success', description: 'Task Updated Successfully' })
        setModalOpen(false)
        setEditTask(null)
        resetForm()
        fetchTasks()
      } else {
        toast({ title: 'Error', description: data?.message || 'Failed to update task' })
      }
 
    } catch (err) {
      console.error('handleUpdateTask', err)
      toast({ title: 'Error', description: 'Failed to update task' })
    }
  }


  // To edit existing task
  async function openEditModal(task: TaskItem) { 
    let tdata: any = task
    const missingContacts =!tdata.contacts || (Array.isArray(tdata.contacts) && tdata.contacts.length === 0)
    const missingName = !tdata.taskName && !tdata.subject

    if ((missingContacts || missingName) && tdata.taskId) {
      const full = await fetchTaskDetails(tdata.taskId)
      if (full) tdata = { ...tdata, ...full }
    }

    setEditTask(tdata)
    setSubject(tdata.taskName || tdata.subject || '')
    setDescription(tdata.taskComment || tdata.taskComments || '')
    const assignedId = tdata.taskAssignedId || tdata.assignedTo || ''
    setAssignedToId(assignedId)
    const assignedName = tdata.taskAssignedName || ''
    setQuery(assignedName)
    setAssignedToName(assignedName)
    setTaskType(tdata.taskType || '')
    setStatus(tdata.taskStatus || '')

    if (tdata.taskDate) {
      const iso = String(tdata.taskDate).replace(' ', 'T')
      const dt = new Date(iso)
      if (!isNaN(dt.getTime())) {
        setDueDate(dt)
        const hh = dt.getHours().toString().padStart(2, '0')
        const mm = dt.getMinutes().toString().padStart(2, '0')
        setTimeStr(`${hh}:${mm}`)
      } else {
        setDueDate(new Date())
        setTimeStr('10:00')
      }
    } else {
      setDueDate(new Date())
      setTimeStr('10:00')
    }

    const contactIds = tdata.contacts || []
    const contactNamesForAPI = tdata.contactName || []

    setContacts(contactIds)
    setContactNames(contactNamesForAPI)

    setModalOpen(true)
  }

  // To delete a task
  async function deleteTask(taskId: string, originalTaskData: any) {
    try {

     

const clienttimezone = encodeURIComponent(moment.tz.guess());

const rawTaskDate = originalTaskData?.taskDate; 

const formattedDateTime = rawTaskDate ? moment(rawTaskDate, 'YYYY-MM-DD HH:mm:ss.S').format('YYYY-MM-DD HH:mm:ss') : '';

const formattedDueTime = rawTaskDate ?  moment(rawTaskDate, 'YYYY-MM-DD HH:mm:ss.S').format('HH:mm') : '';

const taskContactNames = normalizeToArray(originalTaskData?.contactName)

const payload = {
  subject: originalTaskData?.subject || originalTaskData?.taskName || subject,
  dueDate: formattedDateTime,
  dueTime: formattedDueTime, 
  contacts: normalizeToArray(originalTaskData?.contacts),
  contactName: taskContactNames,
  assignedTo: originalTaskData?.taskAssignedId || originalTaskData?.assignedTo || '',
  clienttimezone,
  status: 'Dismiss',
  taskType: originalTaskData?.taskType || '',
  taskComments:
    originalTaskData?.taskComments || originalTaskData?.taskComment || description,
  module_name: 'Task',
  action: 'Dismiss',
  taskId: taskId,
}
      const encoded = new URLSearchParams({ data: JSON.stringify(payload) }).toString()
      const res = await fetch(`${API_CONFIG.baseUrl}/task/addTask`, {
        method: 'POST',
        headers: createAuthHeaders({
          'Content-Type': 'application/x-www-form-urlencoded; charset=UTF-8',
          Accept: 'application/json, text/javascript, */*; q=0.01',
        }),
        body: encoded,
        credentials: 'include',
      })
      const data = await res.json()

      if (data?.status === 1) {
        toast({ title: 'Deleted', description: 'Task Deleted Successfully' })
        fetchTasks()
      } else {
        toast({ title: 'Error', description: data?.message || 'Delete failed' })
      }
    } catch (err) {
      console.error('deleteTask', err)
      toast({ title: 'Error', description: 'Delete failed' })
    }
  }

  // Reset form fields
  function resetForm() {
    setSubject('')
    setAssignedTo('')
    setTaskType('')
    setStatus('')
    setContacts([])
    setContactNames([])
    setDescription('')
    const now = new Date()
    setDueDate(now)
    const hh = now.getHours().toString().padStart(2, '0')
    const mm = now.getMinutes().toString().padStart(2, '0')
    const currentTimeString = `${hh}:${mm}`
    setTimeStr(currentTimeString)
  }

  // Calculate time data for due date
  const calcTimeData = (due: string | undefined) => {
    if (!due) return null

    const dueDate = new Date(due)
    const now = new Date()
    const diffMs = dueDate.getTime() - now.getTime()

    const isOverdue = diffMs < 0
    const absDiffMs = Math.abs(diffMs)

    const days = Math.floor(absDiffMs / 86400000)
    const hours = Math.floor((absDiffMs % 86400000) / 3600000)
    const mins = Math.floor(((absDiffMs % 86400000) % 3600000) / 60000)

    let timeDiffText
    if (days > 0) timeDiffText = `${days} Day(s)`
    else if (hours > 0) timeDiffText = `${hours} Hour(s)`
    else if (mins > 0) timeDiffText = `${mins} Min(s)`
    else timeDiffText = '0 Min(s)'

    const label = isOverdue ? 'Over Due' : 'Time To Complete'

    const statusClass = isOverdue ? 'bg-red-500' : 'bg-blue-500'

    return {
      text: timeDiffText,
      fullText: `${timeDiffText} ${label}`,
      statusClass: statusClass,
    }
  }

 return (
    <div className="p-5">
  <div className="flex justify-end mb-4">
    <button
      onClick={() => {
        setEditTask(null)
        resetForm()
        setModalOpen(true)
      }}
      className="rounded bg-blue-600 px-6 py-2 text-white shadow hover:bg-blue-700"
      title="Add Task"
    >
      Add
    </button>
  </div>

      <div className=''></div>
      {loading ? (
        <div>Loading...</div>
      ) : tasks.length === 0 ? (
        <p>No tasks found</p>
      ) : (
        <>
          {showAllTasks ? (
            <DataTableAllTasks 
                tasks={tasks} 
                openEditModal={openEditModal} 
                handleDeleteClick={handleDeleteClick} 
            />
          ) : (
            <ul className="space-y-3">
              {tasksToShow.map((t) => {
                const due = t.taskDate
                const timeData =
                  t.taskDate && t.taskStatus !== 'Completed' ? calcTimeData(t.taskDate) : null

                return (
                  <li key={t.taskId} className="relative rounded border bg-gray-50 p-3 shadow-sm">
                    <h3 className="font-bold">{t.taskName}</h3>
                    <p>{t.taskComment || '-'}</p>
                    <p className="text-sm text-gray-600">
                      DueDate/Time: {due || '-'} | Status: {t.taskStatus || '-'} | Assignee: {t.taskAssignedName || '-'} | Task Type: {t.taskType || '-'}
                    </p>

                    {timeData && (
                      <small
                        className={`absolute right-4 top-2 rounded px-2 py-1 text-xs text-white ${timeData.statusClass}`}
                        title={timeData.fullText}
                      >
                        {timeData.fullText}
                      </small>
                    )}

                      <div className="mt-2 flex gap-3">
                      <button
                        className="p-2 text-yellow-600 hover:text-yellow-800"
                        onClick={() => openEditModal(t)}
                        title="Edit Task"
                      >
                        <PencilIcon className="h-5 w-5" />
                      </button>

                       <button
                        className="p-2 text-red-600 hover:text-red-800"
                        onClick={() => handleDeleteClick(t.taskId, t)}
                        title="Delete Task"
                      >
                        <TrashIcon className="h-5 w-5" />
                      </button>
                    </div>
                  </li>
                )
              })}
            </ul>
          )}

          { hasMoreTasks && (
            <div className="mt-4 text-center">
                <button 
                    onClick={() => setShowAllTasks(!showAllTasks)}
                    className="flex items-center mx-auto px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition duration-150"
                >
                    {showAllTasks ? (
                        <>
                            Show Less <ChevronUpIcon className="ml-2 h-4 w-4" />
                        </>
                    ) : (
                        <>
                            More ...  <ChevronDownIcon className="ml-2 h-4 w-4" />
                        </>
                    )}
                </button>
            </div>
          )}
        </>
      )}
      
      <DeleteConfirmationModal 
        isOpen={isDeleteModalOpen} 
        onClose={closeDeleteModal} 
        onConfirm={handleConfirmDelete} 
      />

      {isModalOpen && (
        <Dialog.Root open={isModalOpen} onOpenChange={setModalOpen}>
          <Dialog.Portal>
            <Dialog.Overlay className="fixed inset-0 z-20 bg-black/40 backdrop-blur-sm" />

            <Dialog.Content className="fixed left-1/2 top-1/2 z-50 w-[700px] -translate-x-1/2 -translate-y-1/2 rounded-lg bg-white p-5 shadow-xl">
              <Dialog.Close className="absolute right-3 top-3 text-gray-600 hover:text-black">
                X
              </Dialog.Close>

              <Dialog.Title className="mb-4 text-xl font-semibold">
                {editTask ? 'Update Task' : 'Add Task'}
              </Dialog.Title>

               <label htmlFor="assignTo" className="mb-2 block">
                Assign To (Choose Only One Employee As Assignee) <span className="text-red-500">*</span>
              </label>

              <div className="relative">
                <Search className="absolute left-3 top-1/2 h-4 w-4 -translate-y-1/2 transform text-prism-primary" />
                <Input
                  ref={inputRef}
                  type="text"
                  placeholder="Search..."
                  value={query}
                  onChange={handleInputChange}
                  autoFocus
                  id="searchInput"
                  className="h-full min-h-[3rem] flex-1 rounded-md border border-gray-300 bg-gray-50 pl-10 pr-24 text-base focus:border-prism-primary focus:bg-white"
                  style={{ paddingRight: '6rem', height: '100%' }}
                />
                {isOpen && query.length > 0 && (
                  <ul className="absolute z-10 mt-1 max-h-60 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5 focus:outline-none sm:text-sm">
                    {loadingSearch ? (
                      <li className="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-700">
                        Loading...
                      </li>
                    ) : assigneeResults.length > 0 ? (
                      assigneeResults.map((assignee) => (
                        <li
                          key={assignee.value}
                          className="relative cursor-pointer select-none py-2 pl-3 pr-9 text-gray-900 hover:bg-prism-primary hover:text-white"
                          onClick={() => {
                            handleAssigneeSelect(assignee)
                          }}
                        >
                          {assignee.text}
                        </li>
                      ))
                    ) : (
                      <li className="relative cursor-default select-none py-2 pl-3 pr-9 text-gray-700">
                        No results found
                      </li>
                    )}
                  </ul>
                )}
              </div>

               <div className="flex justify-between items-end  mb-4">
                <div className="flex flex-col">
                  <label>Due Date<span className="text-red-500">*</span></label>
                  <DatePicker
                    selected={dueDate}
                    onChange={(d: Date | null) => setDueDate(d)}

                    className=" rounded border items-baseline p-2 w-full" 
                  />
                </div>
                <div className="flex flex-col">
                  <label>Time<span className="text-red-500">*</span></label>
                 <TimePicker
    onChange={setTimeStr} 
    value={timeStr}
    format="h:mm a" 
    className="rounded border p-2 w-48" 
    clearIcon={null} 
  />
                </div>
 
               </div>


              <label>Task Type<span className="text-red-500">*</span></label>
              <select
                value={taskType}
                onChange={(e) => setTaskType(e.target.value)}
                className="mb-3 w-full rounded border p-2"
              >
                <option value="">-- Select --</option>
                <option value="Call Back1">Call Back1</option>
                <option value="Action items">Action Items</option>
                <option value="Others">Others</option>
                <option value="Schedule Meeting">Schedule Meeting</option>
              </select>

              <label>Status<span className="text-red-500">*</span></label>
              <select
                value={status}
                onChange={(e) => setStatus(e.target.value)}
                className="mb-3 w-full rounded border p-2"
              >
                <option value="">-- Select --</option>
                <option value="Not Started">Not Started</option>
                <option value="Completed">Completed</option>
                <option value="In Progress">In Progress</option>
              </select>

              <label>Subject<span className="text-red-500">*</span></label>
              <input
                type="text"
                value={subject}
                onChange={(e) => setSubject(e.target.value)}
                className="mb-3 w-full rounded border p-2"
              />

              <label className="mb-2 block">Contacts<span className="text-red-500">*</span></label>
              <div className="relative mb-3 h-full min-h-[3rem] rounded-md border border-gray-300 bg-gray-50 focus-within:border-prism-primary focus-within:bg-white">
                {contacts.map((contactId, index) => {
                  const name = contactNames[index]
                  if (!name) return null

                  return (
                    <span
                      key={contactId}
                      className="flex items-center rounded bg-blue-100 px-2.5 py-0.5 text-sm font-medium text-blue-800"
                    >
                      {name}
                      <button
                        type="button"
                        onClick={() => removeContact(contactId)}
                        className="ml-1 text-blue-800 hover:text-blue-900 focus:outline-none"
                        aria-label={`Remove contact ${name}`}
                      >
                        &times;
                      </button>
                    </span>
                  )
                })}

                <Input
                  type="text"
                  placeholder="Search and add contacts..."
                  value={contactQuery}
                  onChange={handleContactInputChange}
                  onFocus={() => setIsContactResultsOpen(true)}
                  className="w-full min-w-[150px] flex-1 border-none bg-transparent p-0 text-base focus:outline-none"
                />
              </div>

              {isContactResultsOpen && (contactQuery.length > 0 || contactResults.length > 0) && (
                <ul className="absolute z-20 mt-1 max-h-40 w-full overflow-auto rounded-md bg-white py-1 text-base shadow-lg ring-1 ring-black/5">
                  {loadingContacts ? (
                    <li key="loading" className="p-2 text-gray-700">
                      Loading...
                    </li>
                  ) : contactResults.length > 0 ? (
                    contactResults.map((contact) => {
                      return (
                        <li
                          key={contact.value}
                          className="cursor-pointer p-2 hover:bg-prism-primary hover:text-white"
                          onClick={() => handleContactSelect(contact)}
                        >
                          {contact.text}
                        </li>
                      )
                    })
                  ) : (
                    <li key="no-results" className="p-2 text-gray-700">
                      No contacts found
                    </li>
                  )}
                </ul>
              )}

              <label>Description</label>
              <textarea
                value={description}
                onChange={(e) => setDescription(e.target.value)}
                className="mb-4 w-full rounded border p-2"
                rows={3}
              />

              <div className="flex justify-end gap-3">
                <Dialog.Close>
                  <button className="rounded bg-gray-300 px-4 py-2">Cancel</button>
                </Dialog.Close>

                <button
                  onClick={editTask ? handleUpdateTask : handleAddTask}
                  className="rounded bg-blue-600 px-4 py-2 text-white"
                >
                  {editTask ? 'Update' : 'Add'}
                </button>
              </div>
            </Dialog.Content>
          </Dialog.Portal>
        </Dialog.Root>
      )}
    </div>
    
  )
}


